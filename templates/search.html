{% extends "base.html" %}

{% block head %}
<style>
  .search-results-row > article.card.search-card {
    min-width: 200px;
    max-width: 200px;
    height: 310px;
    display: flex;
    flex-direction: column;
  }

  .search-card .card__thumb {
    padding: 8px;
    border-radius: 14px;
  }

  .search-card .card__thumb img,
  .search-card .card__thumb iframe,
  .search-card .thumb-frame {
    height: 128px;
    border-radius: 10px;
  }

  .search-card .card__body {
    padding: 10px 11px 12px;
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    overflow: hidden;
  }

  .search-card .card__body h4 {
    font-size: 15px;
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-card .card__body p {
    font-size: 12px;
  }

  .search-card .card__body p:last-child {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
{% endblock %}

{% block content %}
<div class="container content-card">
  <h2>Search results</h2>
  <form method="get" class="hero-search" style="margin-bottom:12px">
    <input name="q" value="{{ q }}" placeholder="Search presentations, authors, tags..." />
    <button class="btn" type="submit">Search</button>
  </form>

  {% if results %}
  <div class="scroll-row" data-scroll-row>
    <button class="scroll-row__nav prev" data-scroll-prev aria-label="Scroll left">‹</button>
    <div class="grid grid--cards scroll-row__track search-results-row" data-scroll-track>
    {% for r in results %}
    <article class="card card--wide search-card" data-pid="{{ r.id }}">
      {% set is_pdf = r.filename and r.filename.lower().endswith('.pdf') %}
      {% set slide_thumb = '/presentations/' ~ r.id ~ '/slide/0?v=' ~ (r.filename or r.id) %}
      {% set thumb_pdf = '/download/' ~ r.filename ~ '?inline=1#page=1&view=FitH&toolbar=0&navpanes=0' if is_pdf else None %}
      {% set cover_or_pdf = (r.cover_url|public_media_url) or thumb_pdf or request.url_for('static', path='cover-placeholder.svg') %}

      <a class="card__link" href="{{ url_for('view_presentation', presentation_id=r.id) }}">
        <div class="card__thumb" style="position:relative;">
          {% if is_pdf %}
          <iframe class="thumb-frame" src="{{ cover_or_pdf }}" loading="lazy"></iframe>
          {% else %}
          <img src="{{ slide_thumb }}" alt="{{ r.title }}" loading="lazy" data-fallback="/presentations/{{ r.id }}/slide/0" data-placeholder="{{ request.url_for('static', path='slide-placeholder.svg') }}" onerror="if(this.dataset.fallbackUsed!=='1'){this.dataset.fallbackUsed='1';this.src=this.dataset.fallback;}else{this.onerror=null;this.src=this.dataset.placeholder;}" />
          {% endif %}
        </div>
        <div class="card__body">
          <h4>{{ r.title }}</h4>
          <p class="muted">by&nbsp;{% if r.owner_username %}<a href="/users/{{ r.owner_username }}">{{ r.owner_username }}</a> <span class="role-badge role-badge--{{ (r.owner_site_role|default('passerby'))|lower }}">★</span>{% else %}Unknown{% endif %}</p>
        </div>
      </a>
      <button class="card__bookmark" type="button" data-id="{{ r.id }}" aria-label="Save presentation" title="Save for later">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M6 3a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18l-7-4-7 4V3z"/></svg>
      </button>
    </article>
    {% endfor %}
    </div>
    <button class="scroll-row__nav next" data-scroll-next aria-label="Scroll right">›</button>
  </div>
  {% else %}
  <div class="empty">No results found for "{{ q }}".</div>
  {% endif %}
</div>
{% endblock %}
