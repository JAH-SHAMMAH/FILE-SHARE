{% extends "base.html" %}
{% block content %}
<div class="container content-card">
  <h2>Search results</h2>
  <form method="get" class="hero-search" style="margin-bottom:12px">
    <input name="q" value="{{ q }}" placeholder="Search presentations, authors, tags..." />
    <button class="btn" type="submit">Search</button>
  </form>

  <div class="results">
    {% if results %}
      <div class="grid">
        {% for r in results %}
        <article class="card" data-pid="{{ r.id }}">
          {% set is_pdf = r.filename and r.filename.lower().endswith('.pdf') %}
          {% set slide_thumb = '/presentations/' ~ r.id ~ '/slide/0' %}
          {% set thumb_pdf = '/download/' ~ r.filename ~ '?inline=1#page=1&view=FitH&toolbar=0&navpanes=0' if is_pdf else None %}
          {% set cover_or_pdf = r.cover_url or thumb_pdf or request.url_for('static', path='cover-placeholder.svg') %}
          <a class="card__thumb" href="/presentations/{{ r.id }}">
            {% if is_pdf %}
            <div class="thumb-frame thumb-frame--pdf" data-pdf="{{ cover_or_pdf }}" data-cover="{{ r.cover_url or '' }}">
              <canvas class="thumb-canvas" aria-label="{{ r.title }} preview"></canvas>
              <object data="{{ cover_or_pdf }}" data-thumb="{{ cover_or_pdf }}" type="application/pdf" class="thumb-object" aria-label="{{ r.title }} preview"></object>
            </div>
            {% else %}
            <img src="{{ slide_thumb }}" alt="{{ r.title }}" data-cover="{{ r.cover_url or '' }}" data-placeholder="{{ request.url_for('static', path='cover-placeholder.svg') }}" />
            {% endif %}
          </a>
          <div class="card__body">
            <a class="card__title" href="/presentations/{{ r.id }}">{{ r.title }}</a>
            <div style="display:flex;align-items:center;gap:8px;">
              <div class="card__meta">{{ r.owner.username if r.owner else 'Unknown' }} • {{ r.created_at.strftime('%Y-%m-%d') if r.created_at else '' }}</div>
              <div class="card__saved" title="Saved count" data-id="{{ r.id }}">⭐ {{ r.bookmarks_count or 0 }}</div>
            </div>
            <p class="card__desc">{{ r.description or "-" }}</p>
            <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
              {% if r.owner_id %}
                <button class="btn btn--small btn-contact" data-user-id="{{ r.owner_id }}" data-username="{{ r.owner_username }}" data-email="{{ r.owner_email if r.owner_email is defined else '' }}">
                  <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 8a2 2 0 0 0-2-2h-1V5a3 3 0 0 0-3-3H9A3 3 0 0 0 6 5v1H5a2 2 0 0 0-2 2v2h18V8zM3 12v6a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3v-6H3z"/></svg>
                  Contact
                </button>
                <button class="btn btn--small btn-message" data-user-id="{{ r.owner_id }}" data-username="{{ r.owner_username }}">
                  <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                  Message <span class="msg-badge" data-user-id="{{ r.owner_id }}"></span>
                </button>
                <span class="presence-dot" data-user-id="{{ r.owner_id }}" style="width:8px;height:8px;border-radius:50%;background:#ccc;display:inline-block;margin-left:6px"></span>
              {% endif %}
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">No results found for "{{ q }}".</div>
    {% endif %}
  </div>
</div>
{% endblock %}
