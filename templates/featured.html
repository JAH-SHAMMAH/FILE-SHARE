{% extends 'base.html' %}

{% block content %}
{% set cu = (current_user if (current_user is defined and current_user) else (request.state.current_user if request and request.state else None)) %}
{% if cu %}
  {% set current_category = request.query_params.get('category', '') %}
  <section class="container category-bar" style="margin-top:12px;">
    <div style="display:flex;flex-direction:column;gap:8px;">
      <div class="suggested-chips">
        {% set suggested = ['For You','Business','Mobile'] %}
        {% for s in suggested %}
          <a class="suggested-chip{% if s == (current_category or 'For You') %} active{% endif %}" href="/search?category={{ s|url_encode }}">{{ s }}</a>
        {% endfor %}
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div id="category-scroll" class="category-scroll" role="list">
          {% for c in request.state.categories or [] %}
            <a role="listitem" data-cat="{{ c }}" class="category-chip{% if c == current_category %} active{% endif %}" href="/search?category={{ c|url_encode }}">{{ c }}</a>
          {% endfor %}
        </div>
        <a class="muted" href="/categories" style="font-weight:700;text-decoration:none;">Show all categories ▾</a>
      </div>
    </div>
  </section>

  <script src="{{ request.url_for('static', path='js/categories.js') }}" defer></script>
{% endif %}
<section class="container" style="margin-top:18px;">
  <div class="panel-head">
    <h1 class="section-title">Featured presentations</h1>
    <p class="muted">Curated and spotlighted decks — slide through the selection.</p>
  </div>

  <div class="featured-carousel">
    <div class="featured-nav" style="left:8px;">
      <button id="featured-prev" class="prev" aria-label="Scroll left">◀</button>
    </div>

    <div class="featured-track" id="featured-track" data-carousel>
      {% for p in featured %}
      <article class="featured-card card" data-pid="{{ p.id }}">
        <a class="card__link" href="{{ url_for('view_presentation', presentation_id=p.id) }}">
          <div class="card__thumb">
            {% set is_pdf = p.filename and p.filename.lower().endswith('.pdf') %}
            {% set slide_thumb = '/presentations/' ~ p.id ~ '/slide/0' %}
            {% if is_pdf %}
              <iframe class="thumb-frame" src="/download/{{ p.filename }}?inline=1#page=1&view=FitH&toolbar=0&navpanes=0" loading="lazy"></iframe>
            {% else %}
              <img src="{{ slide_thumb }}" alt="{{ p.title }}" loading="lazy" onerror="this.onerror=null;this.src='{{ request.url_for('static', path='slide-placeholder.svg') }}'" />
            {% endif %}
          </div>
          <div class="card__body">
            <h4>{{ p.title }}</h4>
            <p class="muted">by {% if p.owner_username %}<a href="/users/{{ p.owner_username }}">{{ p.owner_username }}</a>{% else %}{{ p.author or 'Unknown' }}{% endif %} · {{ p.views or 0 }} views</p>
          </div>
        </a>
        <div class="card__actions">
          {% if p.owner_id %}
            <button class="btn btn--ghost btn-contact" data-user-id="{{ p.owner_id }}" data-username="{{ p.owner_username }}" data-email="{{ p.owner_email }}">Contact Owner</button>
          {% endif %}
          {% if p.filename %}
            <a class="btn" href="{{ url_for('download_file', filename=p.filename) }}">Download</a>
          {% endif %}
        </div>
      </article>
      {% endfor %}
    </div>

    <div class="featured-nav" style="right:8px;">
      <button id="featured-next" class="next" aria-label="Scroll right">▶</button>
    </div>
  </div>
</section>
{% endblock %}
