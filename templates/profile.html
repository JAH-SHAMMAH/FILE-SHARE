{% extends "base.html" %}
{% block content %}
<div class="container content-card profile-page">
  <div class="profile-header" style="display:flex;gap:16px;align-items:center">
    <div class="avatar">
      {% set initials = (user_obj.username or '??')[:2].upper() %}
      {% if user_obj.avatar %}
      <img src="/download/{{ user_obj.avatar }}?inline=1" alt="avatar" style="width:120px;height:120px;border-radius:12px" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
      {% endif %}
      <div class="avatar-fallback" style="width:120px;height:120px;border-radius:12px;display:{% if user_obj.avatar %}none{% else %}flex{% endif %};align-items:center;justify-content:center;font-weight:800;font-size:32px;color:#1f1f3f;background:linear-gradient(135deg,#eef1ff,#ffd9a8);">
        {{ initials }}
      </div>
    </div>
    <div>
      <h2>{{ user_obj.full_name or user_obj.username }}</h2>
      <p class="muted">{{ user_obj.bio or 'No bio provided yet.' }}</p>
      <div class="meta muted">Followers: {{ follower_count }} • Following: {{ following_count }}</div>
      <div style="margin-top:8px;">
        <div><strong>Email:</strong> {{ user_obj.email or '—' }}</div>
        {% if user_obj.country %}<div><strong>Country:</strong> {{ user_obj.country }}</div>{% endif %}
        {% if user_obj.state %}<div><strong>State:</strong> {{ user_obj.state }}</div>{% endif %}
      </div>
      {% if user_obj.date_of_birth %}
      <div class="meta muted">Born: {{ user_obj.date_of_birth }}</div>
      {% endif %}
      {% if current_user and current_user.username == user_obj.username %}
      <div style="margin-top:8px"><a class="btn" href="/me/edit">Edit profile</a></div>
      {% endif %}
    </div>
  </div>

  <section style="margin-top:18px">
    <h3>Presentations</h3>
    <div class="grid">
      {% for p in presentations %}
      <article class="card" data-pid="{{ p.id }}">
        {% set is_pdf = p.filename and p.filename.lower().endswith('.pdf') %}
        {% set slide_thumb = '/presentations/' ~ p.id ~ '/slide/0' %}
        {% set thumb_pdf = '/download/' ~ p.filename ~ '?inline=1#page=1&view=FitH&toolbar=0&navpanes=0' if is_pdf else None %}
        {% set cover_or_pdf = p.cover_url or thumb_pdf or request.url_for('static', path='cover-placeholder.svg') %}
        <a class="card__thumb" href="/presentations/{{ p.id }}">
          {% if is_pdf %}
          <div class="thumb-frame thumb-frame--pdf" data-pdf="{{ cover_or_pdf }}" data-cover="{{ p.cover_url or '' }}">
            <canvas class="thumb-canvas" aria-label="{{ p.title }} preview"></canvas>
            <object data="{{ cover_or_pdf }}" data-thumb="{{ cover_or_pdf }}" type="application/pdf" class="thumb-object" aria-label="{{ p.title }} preview"></object>
          </div>
          {% else %}
          <img src="{{ slide_thumb }}" alt="{{ p.title }}" data-cover="{{ p.cover_url or '' }}" data-placeholder="{{ request.url_for('static', path='cover-placeholder.svg') }}" />
          {% endif %}
        
          <div class="card__bookmark-count" data-id="{{ p.id }}" title="Saved count">{{ p.bookmarks_count or 0 }}</div>
        </a>
        <div class="card__body">
          <a class="card__title" href="/presentations/{{ p.id }}">{{ p.title }}</a>
          <div class="card__meta">Views: {{ p.views }}{% if p.category %} • {{ p.category.name }}{% endif %} <span class="card__saved" data-id="{{ p.id }}">⭐ {{ p.bookmarks_count or 0 }}</span></div>
          <p class="card__desc">{{ p.description or "-" }}</p>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            {% set cu = current_user if current_user else None %}
            {% if user_obj.id %}
              <button class="btn btn--small btn-contact" data-user-id="{{ user_obj.id }}" data-username="{{ user_obj.username }}" data-email="{{ user_obj.email }}">Contact Owner</button>
              <button class="btn btn--small btn-message" data-user-id="{{ user_obj.id }}" data-username="{{ user_obj.username }}">Message</button>
            {% elif user_obj.email %}
              <button class="btn btn--small btn-contact" data-user-id="" data-username="" data-email="{{ user_obj.email }}">Contact Owner</button>
            {% endif %}
            <button class="btn btn--small btn-share" data-title="{{ p.title }}" data-id="{{ p.id }}" data-filename="{{ p.filename }}">Share</button>
            {% if p.filename %}
              <a class="btn btn--small" href="/download/{{ p.filename }}">Download</a>
            {% endif %}
          </div>
        </div>
      </article>
      {% else %}
      <div class="empty">No presentations yet.</div>
      {% endfor %}
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    function whatsappShare(text){
      // prefer native share when available
      if (navigator.share){
        try { navigator.share({ text }); return; } catch(e){}
      }
      var url = 'https://wa.me/?text=' + encodeURIComponent(text);
      window.open(url, '_blank');
    }

    document.addEventListener('click', function(ev){
      var btn = ev.target.closest('.btn-share');
      if (!btn) return;
      var title = btn.getAttribute('data-title') || '';
      var id = btn.getAttribute('data-id');
      var filename = btn.getAttribute('data-filename');
      var pageUrl = '';
      if (id && id !== 'None'){
        pageUrl = location.origin + '/presentations/' + id;
      } else if (filename){
        pageUrl = location.origin + '/download/' + filename;
      } else {
        pageUrl = location.href;
      }
      var text = title + '\n' + pageUrl;
      whatsappShare(text);
    }, false);
  })();
</script>
{% endblock %}
