{% extends "base.html" %}
{% block content %}
<div class="container content-card profile-page">
    <div class="profile-header" style="display:flex;gap:16px;align-items:center" data-username="{{ user_obj.username }}">
    <div class="avatar">
      {% set initials = (user_obj.username or '??')[:2].upper() %}
      {% if user_obj.avatar %}
      <a href="/download/{{ user_obj.avatar }}?inline=1" target="_blank" title="Open avatar image">
        <img src="/download/{{ user_obj.avatar }}?inline=1" alt="avatar" style="width:120px;height:120px;border-radius:12px" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
      </a>
      {% endif %}
      <div class="avatar-fallback" style="width:120px;height:120px;border-radius:12px;display:{% if user_obj.avatar %}none{% else %}flex{% endif %};align-items:center;justify-content:center;font-weight:800;font-size:32px;color:#1f1f3f;background:linear-gradient(135deg,#eef1ff,#ffd9a8);">
        {{ initials }}
      </div>
    </div>
    <div>
      <div style="display:flex;align-items:center;gap:12px">
        <h2 style="margin:0">
          {{ user_obj.full_name or user_obj.username }}
          {% if user_obj.site_role %}
            {% set role = user_obj.site_role %}
            <span class="role-badge{% if role == 'teacher' %} role-badge--teacher{% elif role == 'student' %} role-badge--student{% elif role == 'individual' %} role-badge--individual{% elif role == 'passerby' %} role-badge--passerby{% endif %}" title="{{ role|capitalize }}">
              ★
            </span>
          {% endif %}
        </h2>
        {% if current_user and current_user.username != user_obj.username %}
            <button class="btn follow-btn" data-username="{{ user_obj.username }}">{% if is_following %}Unfollow{% else %}Follow{% endif %}</button>
        {% endif %}
        {% if current_user and current_user.username == user_obj.username %}
          <a class="btn" href="/me/edit">Edit profile</a>
        {% endif %}
      </div>
      <p class="muted">{{ user_obj.bio or 'No bio provided yet.' }}</p>
      <p class="muted" style="margin-top:6px;"><strong>{{ owner_presentation_count or 0 }}</strong> presentations · <strong>{{ owner_total_views or 0 }}</strong> views</p>
        <div class="meta muted">Followers: <span id="follower-count">{{ follower_count }}</span> • Following: <span id="following-count">{{ following_count }}</span></div>
      <div style="margin-top:8px;">
        <div><strong>Email:</strong> {{ user_obj.email or '—' }}</div>
        {% if user_obj.country %}<div><strong>Country:</strong> {{ user_obj.country }}</div>{% endif %}
        {% if user_obj.state %}<div><strong>State:</strong> {{ user_obj.state }}</div>{% endif %}
      </div>
      {% if user_obj.date_of_birth %}
      <div class="meta muted">Born: {{ user_obj.date_of_birth }}</div>
      {% endif %}
      
    </div>
  </div>
  <!-- profile tabs -->
  <nav class="profile-tabs" style="margin-top:18px;border-bottom:1px solid var(--border);padding-bottom:12px;">
    <ul style="list-style:none;display:flex;gap:12px;padding:0;margin:0;align-items:center">
      <li><a href="#presentations" class="pill">Presentations</a></li>
      <li><a href="#infographics" class="pill">Infographics</a></li>
      <li><a href="#documents" class="pill">Documents</a></li>
      <li><a href="#likes" class="pill">Likes</a></li>
      <li><a href="#followers" class="pill">Followers</a></li>
      <li><a href="#following" class="pill">Following</a></li>
      <li><a href="#about" class="pill">About</a></li>
    </ul>
  </nav>

  <div id="profile-content">
    <section style="margin-top:18px">
      <h3>Presentations</h3>
      <div class="grid">
      {% for p in presentations %}
      <article class="card" data-pid="{{ p.id }}">
        {% set is_pdf = p.filename and p.filename.lower().endswith('.pdf') %}
        {% set slide_thumb = '/presentations/' ~ p.id ~ '/slide/0' %}
        {% set thumb_pdf = '/download/' ~ p.filename ~ '?inline=1#page=1&view=FitH&toolbar=0&navpanes=0' if is_pdf else None %}
        {% set cover_or_pdf = p.cover_url or thumb_pdf or request.url_for('static', path='cover-placeholder.svg') %}
        <a class="card__thumb" href="/presentations/{{ p.id }}">
          {% if is_pdf %}
          <div class="thumb-frame thumb-frame--pdf" data-pdf="{{ cover_or_pdf }}" data-cover="{{ p.cover_url or '' }}">
            <canvas class="thumb-canvas" aria-label="{{ p.title }} preview"></canvas>
            <object data="{{ cover_or_pdf }}" data-thumb="{{ cover_or_pdf }}" type="application/pdf" class="thumb-object" aria-label="{{ p.title }} preview"></object>
          </div>
          {% else %}
          <img src="{{ slide_thumb }}" alt="{{ p.title }}" data-cover="{{ p.cover_url or '' }}" data-placeholder="{{ request.url_for('static', path='cover-placeholder.svg') }}" />
          {% endif %}
        
          
        </a>
        <div class="card__body">
          <a class="card__title" href="/presentations/{{ p.id }}">{{ p.title }}</a>
          <div class="card__meta">Views: {{ p.views }} • Likes: {{ p.likes_count or 0 }}{% if p.category %} • <a href="/search?category={{ p.category.name|url_encode }}">{{ p.category.name }}</a>{% endif %}</div>
          <p class="card__desc">{{ p.description or "-" }}</p>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button class="btn btn--small btn-share" data-title="{{ p.title }}" data-id="{{ p.id }}" data-filename="{{ p.filename }}">Share</button>
          </div>
        </div>
      </article>
      {% else %}
      <div class="empty">No presentations yet.</div>
      {% endfor %}
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- share handler removed (delegated global handler in static/js/main.js) -->
{% endblock %}
