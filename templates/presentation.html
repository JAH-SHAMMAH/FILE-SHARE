{% extends "base.html" %}
{% block content %}
<div class="container content-card presentation-detail presentation-viewer">
  <div class="presentation-header" style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
    <div>
      <!-- owner summary shown before title -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <a href="/users/{{ p.owner_username }}" style="display:inline-flex;align-items:center;gap:10px;text-decoration:none;color:inherit">
          {% if p.owner_avatar %}
            <img src="/download/{{ p.owner_avatar }}?inline=1" alt="{{ p.owner_username }} avatar" style="width:40px;height:40px;border-radius:10px;object-fit:cover;" onerror="this.style.display='none'" />
          {% else %}
            <div style="width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#eef1ff,#ffd9a8);font-weight:700;color:#1f1f3f">{{ (p.owner_username or 'U')[:1].upper() }}</div>
          {% endif %}
          <div style="line-height:1">
            <div style="font-weight:700">{{ p.owner_username or (p.author or 'Unknown') }} <span class="role-badge role-badge--{{ (p.owner_site_role|default('passerby'))|lower }}">‚òÖ</span></div>
            <div class="muted" style="font-size:12px">{{ owner_presentation_count or 0 }} presentations ¬∑ {{ followers_count or 0 }} followers</div>
            {% if creator_badges %}
              <div class="creator-badges">
                {% for b in creator_badges %}
                  <span class="creator-badge">{{ b }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </a>
      </div>
      <h1>{{ p.title }}</h1>
      {% if current_user and current_user.id == p.owner_id and (p.privacy or 'public') == 'private' %}
        <div class="muted" style="margin-top:4px;font-size:12px;font-weight:600;color:#b91c1c;">
          This presentation is <strong>private</strong> ¬∑ only you can see it.
        </div>
      {% endif %}
      <p class="muted presentation-short-desc" style="margin-top:8px;">{{ p.description or p.ai_description or '' }}</p>
      <p class="muted" style="margin-top:6px;">
        <strong id="owner-count">{{ owner_presentation_count or 0 }}</strong> presentations ¬∑
        <strong id="view-count">{{ p.views or 0 }}</strong> views ¬∑
        <strong>{{ p.downloads or 0 }}</strong> downloads ¬∑
        <strong>{{ likes or 0 }}</strong> likes
      </p>
    </div>
    <div style="display:flex;align-items:flex-start;justify-content:flex-end;flex:0 0 auto;">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
        {% if original_url %}
          {% if current_user and current_user.id == p.owner_id or p.allow_download %}
            <div class="download-menu" data-download-menu>
              <button class="btn btn--download" type="button">Download ‚ñæ</button>
              <div class="download-menu__panel">
                <a href="/presentations/{{ p.id }}/download?kind=original">Original file</a>
                <a href="/presentations/{{ p.id }}/download?kind=pdf">Download PDF</a>
                <a href="/presentations/{{ p.id }}/download?kind=images">Download images</a>
                <a href="/presentations/{{ p.id }}/download?kind=slides">Save slides only</a>
              </div>
            </div>
          {% endif %}
        {% endif %}
        {% if p.owner_id %}
          <button class="btn btn--ghost btn-contact btn-message" data-user-id="{{ p.owner_id }}" data-username="{{ p.owner_username }}" data-email="{{ p.owner_email }}" data-bypass="1">Contact Owner</button>
          {% if current_user and current_user.username != p.owner_username %}
            <button class="btn btn--ghost follow-btn" data-username="{{ p.owner_username }}">{% if is_following %}Unfollow{% else %}Follow{% endif %}</button>
          {% endif %}
          {% if current_user and current_user.id != p.owner_id %}
            <form method="post" action="/presentations/{{ p.id }}/template" class="inline-form">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button class="btn btn--ghost" type="submit">Use as template</button>
            </form>
          {% endif %}
          {% if current_user and current_user.id == p.owner_id %}
          <form id="presentation-delete-form" method="post" action="/presentations/{{ p.id }}/delete" style="display:inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button id="presentation-delete-trigger" class="btn btn--ghost" type="button">Delete</button>
          </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
  <!-- Music player for this presentation -->
  <div id="music-card" style="margin-top:12px;display:{% if p.music_url %}block{% else %}none{% endif %};">
    {% if p.music_url %}
      {% set mu = p.music_url %}
      {% if mu.lower().endswith('.mp3') or mu.lower().endswith('.m4a') or mu.lower().endswith('.ogg') or mu.lower().endswith('.wav') %}
        <audio controls style="width:100%;max-width:680px;">
          <source src="{{ mu }}">Your browser does not support the audio element.
        </audio>
      {% elif 'spotify.com' in mu %}
        <iframe style="border-radius:12px;width:100%;max-width:680px;height:152px;" src="{{ mu|replace('open.spotify.com/', 'open.spotify.com/embed/') }}" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
      {% else %}
        <audio controls style="width:100%;max-width:680px;">
          <source src="{{ mu }}">Your browser does not support the audio element.
        </audio>
      {% endif %}
    {% endif %}
  </div>

  <!-- Owner control: set/clear music URL -->
  {% if current_user and current_user.id == p.owner_id %}
  <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
    <input id="presentation-music-input" placeholder="Paste Spotify/Apple/direct MP3 URL" style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);" value="{{ p.music_url or '' }}" />
    <button id="presentation-music-save" class="btn">Save</button>
    <button id="presentation-music-clear" class="btn btn--ghost">Clear</button>
  </div>
  {% endif %}
  {% if p.music_url and 'spotify.com' in (p.music_url or '') %}
  <div style="margin-top:8px;">
    <button id="spotify-play-btn" class="btn">Play via Spotify</button>
    <span id="spotify-status" class="muted" style="margin-left:8px;"></span>
  </div>
  {% endif %}
  <!-- owner summary moved above title -->

  <!-- Primary actions row placed just before the slide viewer -->
  <div class="presentation-actions" style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:16px;flex-wrap:wrap;">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button class="like-btn btn like-btn--modern {% if is_liked %}liked{% endif %}" data-id="{{ p.id }}" aria-pressed="{{ 'true' if is_liked else 'false' }}">
        <span class="like-btn__label">Like</span>
        <span id="like-count" class="like-btn__count">{{ likes or 0 }}</span>
      </button>
      <button class="bookmark-btn btn {% if is_bookmarked %}bookmarked{% endif %}" data-id="{{ p.id }}" aria-pressed="{{ 'true' if is_bookmarked else 'false' }}" title="Save for later">Save</button>
      <button class="btn btn--ghost" id="save-to-collection" data-presentation-id="{{ p.id }}">Save to folder</button>
      <button class="btn btn--ghost btn-share" data-title="{{ p.title }}" data-id="{{ p.id }}" data-filename="{{ p.filename }}">Share</button>
      {% if p.music_url %}
        <button id="music-toggle-btn" class="btn btn--ghost" title="Show/hide presentation music">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path fill="currentColor" d="M9 18.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Zm0-10V4.75a.75.75 0 0 1 .576-.73l8-2A.75.75 0 0 1 18.5 2.75V8.5a2.5 2.5 0 1 1-1.5-2.291V4.28l-6.5 1.625V16.5a2.5 2.5 0 1 1-1.5-2.291V8.5Z" />
          </svg>
        </button>
      {% endif %}
      {% if current_user %}
        <button id="ai-summary-btn" class="btn btn--primary" title="Summarize this presentation with AI">Summarize (AI)</button>
        <button id="ai-quiz-btn" class="btn btn--ghost" title="Generate quiz from this presentation">Generate Quiz</button>
        <button id="ai-flashcards-btn" class="btn btn--ghost" title="Generate flashcards from this presentation">Flashcards</button>
        <button id="ai-mindmap-btn" class="btn btn--ghost" title="Generate a mind map from this presentation">Mind Map</button>
        
        <div class="ai-slide-dropdown" style="position:relative;display:inline-flex;">
          <button id="ai-slide-btn" class="btn btn--ghost" title="Open AI assistant" aria-haspopup="true" aria-expanded="false">AI Assistant ‚ñæ</button>
          <div id="ai-slide-menu" style="display:none;position:absolute;right:0;top:110%;min-width:220px;background:#fff;border:1px solid var(--border,#e5e7eb);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,0.12);padding:6px;z-index:1400;">
            <button class="btn btn--ghost ai-menu-item" data-ai-action="rephrase" style="width:100%;justify-content:flex-start;">Rephrase</button>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="simplify" style="width:100%;justify-content:flex-start;">Simplify</button>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="key_points" style="width:100%;justify-content:flex-start;">Key points</button>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="elaborate" style="width:100%;justify-content:flex-start;">Elaborate</button>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="adapt_for_audience" style="width:100%;justify-content:flex-start;">Adapt for audience</button>
            <div style="height:1px;background:var(--border,#e5e7eb);margin:6px 4px;"></div>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="explain_like_12" style="width:100%;justify-content:flex-start;">Explain like I'm 12</button>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="real_world_example" style="width:100%;justify-content:flex-start;">Real-world example</button>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="analogy" style="width:100%;justify-content:flex-start;">Analogy</button>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="check_understanding" style="width:100%;justify-content:flex-start;">Check understanding</button>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="glossary" style="width:100%;justify-content:flex-start;">Key terms</button>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="custom" style="width:100%;justify-content:flex-start;">Custom instruction</button>
            <div style="height:1px;background:var(--border,#e5e7eb);margin:6px 4px;"></div>
            <button class="btn btn--ghost ai-menu-item" data-ai-action="open_chat" style="width:100%;justify-content:flex-start;">Open chat</button>
          </div>
        </div>
      {% else %}
        <button class="btn btn--primary" title="Sign in to use AI features" onclick="location.href='/login?next=' + encodeURIComponent(window.location.pathname)">Summarize (AI)</button>
        <button class="btn btn--ghost" title="Sign in to use AI features" onclick="location.href='/login?next=' + encodeURIComponent(window.location.pathname)">Generate Quiz</button>
        <button class="btn btn--ghost" title="Sign in to use AI features" onclick="location.href='/login?next=' + encodeURIComponent(window.location.pathname)">Flashcards</button>
        <button class="btn btn--ghost" title="Sign in to use AI features" onclick="location.href='/login?next=' + encodeURIComponent(window.location.pathname)">Mind Map</button>
        
      {% endif %}
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
        {% if current_user and current_user.id == p.owner_id %}
        <button id="delete-presentation-btn" class="btn" style="background:#dc2626;color:#fff;border-color:#b91c1c;">
          Delete presentation
        </button>
        {% endif %}
      <button id="save-to-drive" class="btn-icon" title="Save to Drive">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      </button>
    </div>
  </div>

  <!-- Two-column viewer: large viewer left, thumbnails right -->
  <div class="presentation-layout presentation-layout--viewer" style="margin-top:18px;">
    <div class="presentation-viewer-main-column main-slide-view">
      {# hidden anchors used by the JS fallback when no thumbnails are available #}
      <a id="viewer-download" href="{{ viewer_url or original_url or '#' }}" style="display:none;">Download</a>
      <a id="viewer-open-original" href="{{ original_url or '#' }}" style="display:none;">Open original</a>

      <div class="presentation-viewer-frame" id="presentation-viewer-frame">
        <div class="presentation-viewer-topbar" aria-label="Presentation controls">
          <div class="presentation-viewer-nav-group">
            <button id="prev-page" type="button" class="viewer-nav-btn" aria-label="Previous slide" title="Previous slide">‚ùÆ Prev</button>
            <button id="next-page" type="button" class="viewer-nav-btn" aria-label="Next slide" title="Next slide">Next ‚ùØ</button>
            <div class="viewer-controls-spacer" aria-hidden="true"></div>
            <div class="viewer-zoom-controls" aria-label="Zoom controls">
              <button id="zoom-out" type="button" class="viewer-zoom-btn" title="Zoom out" aria-label="Zoom out">‚àí</button>
              <span id="zoom-level" class="viewer-zoom-level" aria-live="polite">100%</span>
              <button id="zoom-in" type="button" class="viewer-zoom-btn" title="Zoom in" aria-label="Zoom in">+</button>
            </div>
            <button id="viewer-fullscreen" type="button" class="viewer-fullscreen-btn" aria-label="Enter fullscreen" title="Fullscreen">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M4 9V4h5M20 9V4h-5M4 15v5h5M20 15v5h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <div class="slide-counter" id="page-indicator" aria-live="polite">Slide 1 of 1</div>
        </div>

        <div class="presentation-main-viewer main-viewer" id="presentation-main-viewer" role="region" aria-label="Slide viewer">

        {# Render video uploads as native HTML5 video for best quality; fall back to initial slide image #}
        {% if p.mimetype and p.mimetype.startswith('video') and original_url %}
          <video id="presentation-video" controls preload="metadata" playsinline style="width:100%;max-height:78vh;background:#000;display:block;">
            <source src="{{ original_url }}" type="{{ p.mimetype }}">
            Your browser does not support the video tag. <a href="{{ original_url }}">Download</a>
          </video>
        {% else %}
        <img
          id="presentation-initial-image"
          src="/media/thumbs/{{ p.id }}/slide_0.png"
          alt="Slide preview"
          style="width:100%;display:block;"
          onerror="if(this.dataset.fallbackUsed!=='1'){this.dataset.fallbackUsed='1';this.src='/presentations/{{ p.id }}/slide/0';}else{var ph=document.getElementById('viewer-placeholder'); if(ph){ph.style.display='block';}}"
        />
        <div class="preview-message muted" id="viewer-placeholder" style="display:none;">
          Loading preview‚Ä¶ <a href="{{ original_url or viewer_url }}" target="_blank">Open original</a>.
        </div>
        {% endif %}
        </div>
      </div>
    </div>

    <aside class="presentation-thumbs thumbnail-sidebar thumbnails-sidebar" id="presentation-thumbs" aria-label="Slides thumbnails">
      <!-- thumbnails injected here -->
    </aside>
  </div>

        <!-- fullscreen behavior removed: viewer will display inline with the toolbar visible -->

  {# If conversion is queued for non-PDF uploads, show a clearer placeholder and
     ensure the client-side viewer knows to poll for thumbnails immediately. #}
  {% if conversion_status == 'queued' %}
  <script>
    (function(){
      try{
        const ph = document.getElementById('viewer-placeholder');
        if(ph) ph.textContent = 'Generating previews‚Ä¶ Preview will appear here shortly.';
      }catch(e){}
    })();
  </script>
  {% endif %}

  <div class="presentation-desc" style="margin-top:18px">
    <!-- Keep AI helpers and admin preview only; main description is shown above -->
    <h3 class="sr-only">About this presentation</h3>
    <div id="ai-summary-container" style="margin-top:12px;display:none;">
      <h4>AI Summary</h4>
      <div id="ai-summary-content" class="muted" style="white-space:pre-wrap">{{ ai_summary or '' }}</div>
      <div id="ai-summary-status" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="ai-quiz-container" style="margin-top:12px;display:none;">
      <h4>AI Quiz</h4>
      <div id="ai-quiz-content" class="muted" style="white-space:pre-wrap">{{ ai_quiz or '' }}</div>
      <div id="ai-quiz-status" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="ai-flashcards-container" style="margin-top:12px;display:none;">
      <h4>AI Flashcards</h4>
      <div id="ai-flashcards-content" class="muted" style="white-space:pre-wrap">{{ ai_flashcards or '' }}</div>
      <div id="ai-flashcards-status" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="ai-mindmap-container" style="margin-top:12px;display:none;">
      <h4>AI Mind Map</h4>
      <div id="ai-mindmap-content" class="muted" style="white-space:pre-wrap">{{ ai_mindmap or '' }}</div>
      <div id="ai-mindmap-status" class="muted" style="margin-top:6px"></div>
    </div>
      <div id="ai-slide-container" class="ai-slide-container" aria-hidden="true">
        <div class="ai-assistant-shell">
          <div class="ai-slide-header">
            <div class="ai-slide-title">
              <span class="ai-slide-title-icon">‚ú¶</span>
              <strong>AI Assistant</strong>
            </div>
            <div class="ai-slide-actions">
              <button id="ai-slide-minimize" class="btn btn--ghost" title="Close chat" aria-label="Close assistant">‚úï</button>
            </div>
          </div>

          <div id="ai-slide-chat" class="ai-slide-chat" aria-live="polite">
            <!-- messages appended here -->
          </div>

          <div class="ai-slide-quick-actions" id="ai-slide-quick-actions">
            <button type="button" class="ai-quick-btn" data-quick-action="explain">Explain deeper</button>
            <button type="button" class="ai-quick-btn" data-quick-action="example">Give an example</button>
            <button type="button" class="ai-quick-btn" data-quick-action="question">Ask me a question</button>
          </div>

          <div class="ai-slide-input-bar">
            <div id="ai-slide-preview" class="ai-slide-preview" style="display:none;">
              <img id="ai-slide-thumb" src="" alt="slide thumb" class="ai-slide-thumb" />
            </div>
            <input id="ai-slide-input" type="text" placeholder="Type your instruction‚Ä¶" class="ai-slide-input" />
            <button id="ai-slide-send" class="btn ai-slide-send-btn" type="button">Send</button>
          </div>
        </div>
      </div>
  </div>

  <div id="collection-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-panel">
      <button class="modal-close" data-collection-close>‚úï</button>
      <h3>Save to folder</h3>
      <div class="collection-list" id="collection-list">
        {% if collections %}
          {% for c in collections %}
            <button class="collection-item" data-collection-id="{{ c.id }}">{{ c.name }}</button>
          {% endfor %}
        {% else %}
          <div class="muted">No folders yet.</div>
        {% endif %}
      </div>
      <div class="collection-create">
        <input id="collection-name" placeholder="New folder name" />
        <button class="btn" id="collection-create-btn">Create</button>
      </div>
    </div>
  </div>

  <section class="comments" style="margin-top:18px">
    <h3>Comments</h3>
    <ul>
      {% for c in comments %}
      <li>
        <strong><a href="/profile/{{ c.user_id }}" style="color:inherit;text-decoration:underline;">{{ comment_users.get(c.user_id) or ('User #' ~ c.user_id) }}</a></strong>
        <small class="muted">{{ c.created_at|humanize_comment_date }}</small>
        <div>{{ c.content }}</div>
      </li>
      {% else %}
      <li>No comments yet.</li>
      {% endfor %}
    </ul>
    <form method="post" action="/presentations/{{ p.id }}/comment">
      <textarea name="content" required placeholder="Add a public comment" rows="4"></textarea>
      <div class="auth-actions"><button class="btn">Post comment</button></div>
    </form>
  </section>
</div>
    <!-- Delete confirmation modal (owner only) -->
    {% if current_user and current_user.id == p.owner_id %}
    <div id="delete-modal" style="position:fixed;inset:0;background:rgba(15,23,42,0.7);display:none;align-items:center;justify-content:center;z-index:1000;">
      <div style="background:#fff;border-radius:12px;max-width:420px;width:90%;padding:20px;box-shadow:0 20px 40px rgba(15,23,42,0.35);">
        <h3 style="margin-top:0;margin-bottom:8px;">Delete this presentation?</h3>
        <p class="muted" style="margin:0 0 16px 0;">This will permanently delete "{{ p.title }}" and its files. This action cannot be undone.</p>
        <form method="post" action="/presentations/{{ p.id }}/delete" style="display:flex;gap:8px;justify-content:flex-end;align-items:center;flex-wrap:wrap;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
          <button type="button" id="delete-cancel-btn" class="btn btn--ghost">Cancel</button>
          <button type="submit" class="btn" style="background:#dc2626;color:#fff;border-color:#b91c1c;">Delete</button>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- Post-upload share modal -->
    <div id="upload-share-modal" class="chat-modal" style="display:none;">
      <div class="chat-modal__backdrop"></div>
      <div class="chat-modal__panel" style="max-width:460px;width:100%;">
        <header class="chat-header">
          <div class="chat-header__title" style="font-size:22px;font-weight:800;letter-spacing:0.02em;">
            üéâ IT'S LIVE
          </div>
          <button type="button" class="icon-btn" data-close-share>‚úï</button>
        </header>
        <div style="padding:18px 18px 16px;">
          <p class="muted" style="margin-top:0;margin-bottom:14px;font-size:15px;">
            Let the world see it. Share your story and inspire someone today.
          </p>
          <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px;">
            <a href="#" target="_blank" rel="noopener" class="btn" data-share="facebook">Share on Facebook</a>
            <a href="#" target="_blank" rel="noopener" class="btn btn--ghost" data-share="x">Share on X</a>
            <a href="#" target="_blank" rel="noopener" class="btn btn--ghost" data-share="linkedin">Share on LinkedIn</a>
          </div>
          <button type="button" class="btn btn--ghost" data-copy-link>Copy link</button>
        </div>
      </div>
    </div>
{% endblock %}

{% block scripts %}
<script src="{{ request.url_for('static', path='js/presentation-viewer.js') }}?v=20260218w"></script>
<style>
  .container.content-card.presentation-detail.presentation-viewer {
    width: 100% !important;
    max-width: var(--max-width) !important;
    margin: 0 auto !important;
    min-height: 0 !important;
  }

  .presentation-layout.presentation-layout--viewer {
    width: 100% !important;
    min-height: 0 !important;
  }

  .presentation-layout.presentation-layout--viewer .presentation-viewer-main-column {
    min-width: 0 !important;
    display: block !important;
  }

  .presentation-layout.presentation-layout--viewer .presentation-viewer-frame {
    width: 100% !important;
    height: min(76vh, 920px) !important;
    min-height: 560px !important;
    max-height: calc(100vh - 140px) !important;
    display: flex !important;
    flex-direction: column !important;
    position: relative !important;
    overflow: hidden !important;
  }

  .presentation-layout.presentation-layout--viewer .presentation-main-viewer {
    flex: 1 1 auto !important;
    width: 100% !important;
    height: 100% !important;
    min-height: 0 !important;
    max-height: none !important;
    padding: 0 !important;
    overflow-x: auto !important;
    overflow-y: scroll !important;
    scrollbar-gutter: stable both-edges;
    position: relative !important;
    isolation: isolate !important;
    scrollbar-width: auto !important;
  }

  .presentation-layout.presentation-layout--viewer .presentation-main-viewer .presentation-zoom-stage {
    width: 100% !important;
    height: 100% !important;
    min-height: 100% !important;
    min-width: 100% !important;
    display: flex !important;
    justify-content: center !important;
    align-items: flex-start !important;
    position: relative !important;
  }

  .presentation-layout.presentation-layout--viewer .presentation-main-viewer .slide-container {
    width: auto !important;
    min-width: 0 !important;
    max-width: none !important;
    height: auto !important;
    transform-origin: top center !important;
    position: relative !important;
    inset: auto !important;
  }

  .presentation-layout.presentation-layout--viewer .presentation-main-viewer .slide-image {
    width: 100% !important;
    height: auto !important;
    max-width: none !important;
    max-height: none !important;
    display: block !important;
  }

  .presentation-layout.presentation-layout--viewer .presentation-main-viewer .pdf-page-item {
    width: 100% !important;
  }
  .presentation-layout.presentation-layout--viewer .presentation-main-viewer.pdf-zoom-active .presentation-zoom-content {
    transform: scale(var(--pdf-zoom-scale, 1)) !important;
    transform-origin: top center !important;
    transition: transform 0.2s ease !important;
    will-change: transform !important;
  }
  body .container.content-card.presentation-detail.presentation-viewer #presentation-main-viewer.pdf-zoom-active .presentation-zoom-content {
    transform: scale(var(--pdf-zoom-scale, 1)) !important;
    transform-origin: top center !important;
    transition: transform 0.2s ease !important;
    will-change: transform !important;
  }

  .container.content-card.presentation-detail.presentation-viewer .presentation-main-viewer,
  #presentation-main-viewer {
    width: 100% !important;
    max-width: none !important;
    min-width: 0 !important;
    max-height: none !important;
    overflow-x: auto !important;
    overflow-y: scroll !important;
    scrollbar-gutter: stable both-edges;
    -ms-overflow-style: scrollbar;
    scrollbar-width: auto !important;
  }

  #presentation-main-viewer::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }

  #presentation-main-viewer::-webkit-scrollbar-track {
    background: rgba(15, 23, 42, 0.08);
  }

  #presentation-main-viewer::-webkit-scrollbar-thumb {
    background: rgba(15, 23, 42, 0.35);
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.5);
  }

  .container.content-card.presentation-detail.presentation-viewer .presentation-main-viewer > * {
    max-width: none !important;
    position: relative !important;
    inset: auto !important;
  }

  #ai-slide-container .ai-assistant-shell {
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  #ai-slide-container .ai-slide-preview {
    width: 100%;
    max-height: 120px;
    overflow: hidden;
    border-radius: 8px;
    margin-bottom: 8px;
    flex: 0 0 auto;
  }

  #ai-slide-container .ai-slide-preview img {
    width: 100%;
    height: auto;
    object-fit: contain;
    display: block;
    max-width: none;
  }

  #ai-slide-container .ai-slide-input-bar {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
    position: static;
  }

  #ai-slide-container .ai-slide-input {
    width: 100%;
  }

  @media (max-width: 900px) {
    .container.content-card.presentation-detail.presentation-viewer {
      width: 100% !important;
      max-width: 100% !important;
    }

    .presentation-layout.presentation-layout--viewer {
      min-height: 0 !important;
    }

    .presentation-layout.presentation-layout--viewer .presentation-viewer-frame {
      height: min(68vh, 760px) !important;
      min-height: 460px !important;
    }

    .presentation-layout.presentation-layout--viewer .presentation-main-viewer {
      height: 100% !important;
      min-height: 0 !important;
    }

    .presentation-layout.presentation-layout--viewer .presentation-main-viewer .slide-image {
      max-height: none !important;
    }
  }
</style>
<script>
// Global presentation metadata for this page
const presentationId = "{{ p.id }}";
const presentationFilename = "{{ p.filename or '' }}";
const viewerUrl = "{{ viewer_url or '' }}";

// Share modal controls (manual share + post-upload share)
(function(){
  const modal = document.getElementById('upload-share-modal');
  if (!modal) return;

  const shareBtn = document.querySelector('.btn-share');
  const backdrop = modal.querySelector('.chat-modal__backdrop');
  const closeButtons = modal.querySelectorAll('[data-close-share]');
  const fb = modal.querySelector('[data-share="facebook"]');
  const x = modal.querySelector('[data-share="x"]');
  const li = modal.querySelector('[data-share="linkedin"]');
  const copyBtn = modal.querySelector('[data-copy-link]');
  const params = new URLSearchParams(window.location.search);
  const justUploaded = params.get('just_uploaded') === '1';

  const baseUrl = window.location.origin + window.location.pathname;

  if (fb) {
    fb.href = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(baseUrl);
  }
  if (x) {
    const text = 'Check out my new presentation on 247FileShare';
    x.href = 'https://twitter.com/intent/tweet?url=' + encodeURIComponent(baseUrl) + '&text=' + encodeURIComponent(text);
  }
  if (li) {
    li.href = 'https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(baseUrl);
  }

  function closeShare(){ modal.style.display = 'none'; }
  function openShare(){ modal.style.display = 'flex'; }

  if (shareBtn) {
    shareBtn.addEventListener('click', function(){ openShare(); });
  }
  closeButtons.forEach(function(btn){
    btn.addEventListener('click', function(){ closeShare(); });
  });
  if (backdrop) {
    backdrop.addEventListener('click', function(ev){
      if (ev.target === backdrop) closeShare();
    });
  }

  if (copyBtn && navigator.clipboard && navigator.clipboard.writeText){
    copyBtn.addEventListener('click', async function(){
      try{
        await navigator.clipboard.writeText(baseUrl);
        const original = copyBtn.textContent;
        copyBtn.textContent = 'Link copied';
        setTimeout(function(){ copyBtn.textContent = original; }, 2000);
      }catch(e){
        alert('Could not copy link');
      }
    });
  }

  if (justUploaded) {
    try{
      params.delete('just_uploaded');
      const newQs = params.toString();
      const newUrl = window.location.pathname + (newQs ? '?' + newQs : '') + window.location.hash;
      window.history.replaceState(null, '', newUrl);
    }catch(e){ /* ignore */ }
    openShare();
  }
})();

// Shared AI poller helper used by summary/quiz/flashcards/mindmap
function makePoller(taskType, contentEl, statusEl){
  return async function pollResult(){
    statusEl.textContent = 'Waiting for result...';
    const start = Date.now();
    while(Date.now() - start < 120000){
      try{
        const r = await fetch(`/api/presentations/${presentationId}/ai/results`, { credentials: 'include', headers: { 'Accept': 'application/json' } });
        if(r.ok){
          const j = await r.json();
          const res = j.results && j.results.find(x=>x.task_type === taskType && x.result);
          if(res){
            if(window.renderAiMarkdown){
              contentEl.innerHTML = window.renderAiMarkdown(res.result || '');
            } else {
              contentEl.textContent = res.result;
            }
            statusEl.textContent = '';
            (contentEl.parentElement || contentEl).style.display = '';
            return true;
          }
        }
      }catch(e){ console.warn(e); }
      await new Promise(r=>setTimeout(r, 2000));
    }
    statusEl.textContent = 'Timed out waiting for AI result.';
    return false;
  }
}

// Client-side AI fallback used for optimistic suggestions and when backend is unavailable
function localAiTransform(action, text, audience){
  try{
    if(!text) return '';
    const sents = text.split(/(?<=[\.\!\?])\s+/).map(s=>s.trim()).filter(Boolean);
    if(action === 'rephrase'){
      return sents.reverse().join(' ') + '\n\n[Rephrased ‚Äî local fallback]';
    }
    if(action === 'simplify'){
      return sents.map(s => s.length > 120 ? s.slice(0, 117) + '‚Ä¶' : s).join(' ') + '\n\n[Simplified ‚Äî local fallback]';
    }
    if(action === 'key_points'){
      const bullets = [];
      for(const s of sents){
        if(bullets.length >= 6) break;
        bullets.push('- ' + (s.length > 220 ? s.slice(0, 217) + '‚Ä¶' : s));
      }
      return bullets.join('\n') || text;
    }
    if(action === 'elaborate'){
      return text + '\n\n[Elaboration not available ‚Äî local fallback]';
    }
    if(action === 'adapt_for_audience'){
      return `Adapted for ${audience || 'the requested audience'}:\n\n` + text;
    }
    return text;
  }catch(e){ return text; }
}

// Presentation viewer initialization (external class)
(function(){
  if(!window.PresentationViewer){
    console.error('[presentation-viewer] script not loaded');
    return;
  }
  const viewer = new window.PresentationViewer({
    presentationId,
    presentationFilename,
    viewerUrl,
  });
  viewer.init();
})();
// AI summary button: enqueue and poll for results
(function(){
  const btn = document.getElementById('ai-summary-btn');
  const container = document.getElementById('ai-summary-container');
  const content = document.getElementById('ai-summary-content');
  const status = document.getElementById('ai-summary-status');
  if(!btn) return;
  try{
    if(content && window.renderAiMarkdown && content.textContent){
      content.innerHTML = window.renderAiMarkdown(content.textContent);
    }
  }catch(e){}
  const summaryPoll = makePoller('summary', content, status);
  btn.addEventListener('click', async ()=>{
    btn.disabled = true;
    btn.textContent = 'Queued‚Ä¶';
    container.style.display = '';
    content.textContent = '';
    status.textContent = 'Requesting summary‚Ä¶';
    try{
      const r = await fetch(`/api/presentations/${presentationId}/ai/summary`, { method: 'POST', credentials: 'include', headers: { 'Accept': 'application/json' } });
      if(!r.ok){
        let txt = '';
        try{ txt = await r.text(); }catch(e){}
        status.textContent = `Request failed: ${r.status} ${txt}`;
        throw new Error('enqueue failed');
      }
      btn.textContent = 'Queued ‚Äî waiting';
      await summaryPoll();
      btn.textContent = 'Summarize (AI)';
      btn.disabled = false;
    }catch(e){
      status.textContent = 'Failed to request AI summary.';
      btn.disabled = false;
      btn.textContent = 'Summarize (AI)';
    }
  });
})();
// AI Quiz / Flashcards / Mind Map buttons
(function(){
  const qbtn = document.getElementById('ai-quiz-btn');
  const qcont = document.getElementById('ai-quiz-container');
  const qcontent = document.getElementById('ai-quiz-content');
  const qstatus = document.getElementById('ai-quiz-status');

  const fbtn = document.getElementById('ai-flashcards-btn');
  const fcont = document.getElementById('ai-flashcards-container');
  const fcontent = document.getElementById('ai-flashcards-content');
  const fstatus = document.getElementById('ai-flashcards-status');

  const mbtn = document.getElementById('ai-mindmap-btn');
  const mcont = document.getElementById('ai-mindmap-container');
  const mcontent = document.getElementById('ai-mindmap-content');
  const mstatus = document.getElementById('ai-mindmap-status');

  if(qbtn){
    const poll = makePoller('quiz', qcontent, qstatus);
    qbtn.addEventListener('click', async ()=>{
      qbtn.disabled = true; qbtn.textContent = 'Queued‚Ä¶'; qcont.style.display = '';
      qcontent.textContent = ''; qstatus.textContent = 'Requesting quiz‚Ä¶';
      try{
        const r = await fetch(`/api/presentations/${presentationId}/ai/quiz`, { method: 'POST', credentials: 'include' });
        if(!r.ok){ let txt=''; try{ txt = await r.text(); }catch(e){}; qstatus.textContent = `Request failed: ${r.status} ${txt}`; throw new Error('enqueue failed'); }
        await poll();
      }catch(e){ qstatus.textContent = 'Failed to request AI quiz.' }
      qbtn.disabled = false; qbtn.textContent = 'Generate Quiz';
    });
  }

  if(fbtn){
    const poll = makePoller('flashcards', fcontent, fstatus);
    fbtn.addEventListener('click', async ()=>{
      fbtn.disabled = true; fbtn.textContent = 'Queued‚Ä¶'; fcont.style.display = '';
      fcontent.textContent = ''; fstatus.textContent = 'Requesting flashcards‚Ä¶';
      try{
        const r = await fetch(`/api/presentations/${presentationId}/ai/flashcards`, { method: 'POST', credentials: 'include' });
        if(!r.ok){ let txt=''; try{ txt = await r.text(); }catch(e){}; fstatus.textContent = `Request failed: ${r.status} ${txt}`; throw new Error('enqueue failed'); }
        await poll();
      }catch(e){ fstatus.textContent = 'Failed to request AI flashcards.' }
      fbtn.disabled = false; fbtn.textContent = 'Flashcards';
    });
  }

  if(mbtn){
    const poll = makePoller('mindmap', mcontent, mstatus);
    mbtn.addEventListener('click', async ()=>{
      mbtn.disabled = true; mbtn.textContent = 'Queued‚Ä¶'; mcont.style.display = '';
      mcontent.textContent = ''; mstatus.textContent = 'Requesting mind map‚Ä¶';
      try{
        const r = await fetch(`/api/presentations/${presentationId}/ai/mindmap`, { method: 'POST', credentials: 'include' });
        if(!r.ok){ let txt=''; try{ txt = await r.text(); }catch(e){}; mstatus.textContent = `Request failed: ${r.status} ${txt}`; throw new Error('enqueue failed'); }
        await poll();
      }catch(e){ mstatus.textContent = 'Failed to request AI mind map.' }
      mbtn.disabled = false; mbtn.textContent = 'Mind Map';
    });
  }
})();
  // AI Slide assistant: chat-style side panel
  (function(){
      const openBtn = document.getElementById('ai-slide-btn');
      const panel = document.getElementById('ai-slide-container');
      const panelHeader = panel ? panel.querySelector('.ai-slide-header') : null;
      const menu = document.getElementById('ai-slide-menu');
      const messagesEl = document.getElementById('ai-slide-chat');
      const input = document.getElementById('ai-slide-input');
      const quickActionsEl = document.getElementById('ai-slide-quick-actions');
      const sendBtn = document.getElementById('ai-slide-send');
      const closeBtn = document.getElementById('ai-slide-minimize');
      const chatHistory = [];
      const maxHistory = 8;
      const dragState = {
        active: false,
        offsetX: 0,
        offsetY: 0,
      };

      if(!openBtn || !panel) return;

      function canDragDesktop(){
        return window.matchMedia('(min-width: 901px)').matches;
      }

      function resetPanelPositionForMobile(){
        if(canDragDesktop()) return;
        panel.style.left = '';
        panel.style.top = '';
        panel.style.right = '';
        panel.style.bottom = '';
      }

      function scrollToBottom(opts){
        if(!messagesEl) return;
        const behavior = (opts && opts.smooth) ? 'smooth' : 'auto';
        try{
          // Ensure DOM has painted before scrolling (important for long replies + suggestions)
          requestAnimationFrame(()=>{
            requestAnimationFrame(()=>{
              try{ messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior }); }
              catch(e){ messagesEl.scrollTop = messagesEl.scrollHeight; }
            });
          });
        }catch(e){
          try{ messagesEl.scrollTop = messagesEl.scrollHeight; }catch(e2){}
        }
      }

      function appendMessage(who, text){
        if(!messagesEl) return null;
        const wrap = document.createElement('div');
        wrap.className = `ai-chat-row ${who === 'user' ? 'ai-chat-row--user' : 'ai-chat-row--assistant'}`;
        const bubble = document.createElement('div');
        bubble.className = `ai-chat-bubble ${who === 'user' ? 'ai-chat-bubble--user' : 'ai-chat-bubble--assistant'}`;
        if(who !== 'user' && window.renderAiMarkdown){
          bubble.innerHTML = window.renderAiMarkdown(text || '');
        } else {
          bubble.textContent = text;
        }
        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
        scrollToBottom({ smooth: true });
        return bubble;
      }

      function showPanel(){
        panel.style.display = 'flex';
        requestAnimationFrame(()=> panel.classList.add('is-open'));
        panel.setAttribute('aria-hidden', 'false');
        if(input) input.focus();
        scrollToBottom({ smooth: false });
      }
      function hidePanel(){
        panel.classList.remove('is-open');
        panel.setAttribute('aria-hidden', 'true');
        try{
          if(messagesEl) messagesEl.innerHTML = '';
          if(input) input.value = '';
          chatHistory.length = 0;
          const previewWrap = document.getElementById('ai-slide-preview');
          const thumbImg = document.getElementById('ai-slide-thumb');
          if(thumbImg){
            thumbImg.src = '';
            thumbImg.style.display = 'none';
          }
          if(previewWrap) previewWrap.style.display = 'none';
        }catch(e){}
        setTimeout(()=>{ if(!panel.classList.contains('is-open')) panel.style.display = 'none'; }, 180);
      }

      function clamp(value, min, max){
        return Math.max(min, Math.min(max, value));
      }

      function onDragMove(e){
        if(!dragState.active || !canDragDesktop()) return;
        const width = panel.offsetWidth || 380;
        const height = panel.offsetHeight || 600;
        const maxLeft = Math.max(8, window.innerWidth - width - 8);
        const maxTop = Math.max(8, window.innerHeight - height - 8);
        const nextLeft = clamp(e.clientX - dragState.offsetX, 8, maxLeft);
        const nextTop = clamp(e.clientY - dragState.offsetY, 8, maxTop);
        panel.style.left = `${nextLeft}px`;
        panel.style.top = `${nextTop}px`;
        panel.style.right = 'auto';
        panel.style.bottom = 'auto';
      }

      function endDrag(){
        if(!dragState.active) return;
        dragState.active = false;
        panel.classList.remove('is-dragging');
      }

      if(panelHeader){
        panelHeader.addEventListener('pointerdown', (e)=>{
          if(!canDragDesktop()) return;
          if(e.target && e.target.closest('#ai-slide-minimize')) return;
          const rect = panel.getBoundingClientRect();
          dragState.active = true;
          dragState.offsetX = e.clientX - rect.left;
          dragState.offsetY = e.clientY - rect.top;
          panel.classList.add('is-dragging');
          try{ panelHeader.setPointerCapture(e.pointerId); }catch(_){ }
          e.preventDefault();
        });
        panelHeader.addEventListener('pointermove', onDragMove);
        panelHeader.addEventListener('pointerup', endDrag);
        panelHeader.addEventListener('pointercancel', endDrag);
      }
      window.addEventListener('resize', resetPanelPositionForMobile);
      function toggleMenu(force){
        if(!menu) return;
        const next = typeof force === 'boolean' ? force : (menu.style.display === 'none' || menu.style.display === '' ? true : false);
        menu.style.display = next ? 'block' : 'none';
        if(openBtn) openBtn.setAttribute('aria-expanded', next ? 'true' : 'false');
      }
      function getActiveSlideText(){
        try{
          const activeItem = document.querySelector('.thumbnail-item.active, .presentation-thumb-wrap.active');
          const thumb = activeItem ? activeItem.querySelector('img.thumbnail-image, img.presentation-thumb') : null;
          if(thumb && thumb.alt){
            const label = String(thumb.alt).trim();
            if(/^(page|slide)\s*\d+$/i.test(label)) return '';
            return label;
          }
        }catch(e){}
        return '';
      }

      function getActiveSlidePreviewSrc(){
        try{
          const activeItem = document.querySelector('.thumbnail-item.active, .presentation-thumb-wrap.active');
          const thumb = activeItem ? activeItem.querySelector('img.thumbnail-image, img.presentation-thumb') : null;
          if(thumb && (thumb.currentSrc || thumb.src)) return thumb.currentSrc || thumb.src;

          const mainImg = document.querySelector('#presentation-main-viewer .slide-image, #presentation-main-viewer img');
          if(mainImg && mainImg.tagName === 'IMG' && (mainImg.currentSrc || mainImg.src)) return mainImg.currentSrc || mainImg.src;

          const mainCanvas = document.querySelector('#presentation-main-viewer canvas');
          if(mainCanvas && typeof mainCanvas.toDataURL === 'function') return mainCanvas.toDataURL('image/png');
        }catch(e){}
        return '';
      }

      function getSlideTextForRequest(){
        let txt = (input && input.value ? input.value : '').trim();
        if(txt) return txt;
        const active = getActiveSlideText();
        if(active) return active;
        return '';
      }

      function buildUserPrompt(action, text, audience){
        const clean = (text || '').trim();
        const base = clean ? `\n\nSlide text:\n${clean}` : '';
        switch(action){
          case 'simplify':
            return `Simplify the slide text to plain, easy-to-understand language.${base}`;
          case 'rephrase':
            return `Rephrase the slide text while preserving meaning and clarity.${base}`;
          case 'key_points':
            return `Extract concise key points from the slide text as bullet points.${base}`;
          case 'elaborate':
            return `Elaborate the slide text with clear explanations and examples.${base}`;
          case 'adapt_for_audience':
            return `Adapt the slide text for the audience: ${audience}.${base}`;
          case 'explain_like_12':
            return `Explain the slide text in simple language suitable for a 12-year-old.${base}`;
          case 'real_world_example':
            return `Give a concrete real-world example that illustrates the slide text.${base}`;
          case 'analogy':
            return `Explain the slide text using a helpful analogy.${base}`;
          case 'check_understanding':
            return `Ask a few short questions to check understanding of the slide text.${base}`;
          case 'glossary':
            return `Extract and define key terms from the slide text.${base}`;
          case 'custom':
            return `Follow my instruction using the slide text.${base}`;
          default:
            return `Help with the slide text.${base}`;
        }
      }

      function openPanelWithContext(reset){
        if(reset){
          if(input) input.value = '';
          if(messagesEl) messagesEl.innerHTML = '';
          const slideText = getActiveSlideText();
          if(input && slideText) input.value = slideText + '\n';
        }
        // populate the small thumbnail preview inside the panel
        try{
          const previewWrap = document.getElementById('ai-slide-preview');
          const thumbImg = document.getElementById('ai-slide-thumb');
          if(thumbImg){
            const previewSrc = getActiveSlidePreviewSrc();
            console.log('Slide selected:', previewSrc || null);
            thumbImg.src = previewSrc || '';
            thumbImg.style.width = '100%';
            thumbImg.style.height = 'auto';
            thumbImg.style.objectFit = 'contain';
            thumbImg.style.display = previewSrc ? 'block' : 'none';
            thumbImg.loading = 'eager';
            thumbImg.decoding = 'async';
            if(previewWrap){
              previewWrap.style.display = previewSrc ? 'block' : 'none';
            }
          }
        }catch(e){}
        showPanel();
        // action selection handled by dropdown
      }

      openBtn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        toggleMenu();
      });
      closeBtn.addEventListener('click', hidePanel);

      document.addEventListener('click', (ev)=>{
        if(!menu || !openBtn) return;
        if(menu.contains(ev.target) || openBtn.contains(ev.target)) return;
        toggleMenu(false);
      });

      const actionLabels = {
        rephrase: 'Rephrase',
        simplify: 'Simplify',
        key_points: 'Key points',
        elaborate: 'Elaborate',
        adapt_for_audience: 'Adapt for audience',
        explain_like_12: "Explain like I'm 12",
        real_world_example: 'Real-world example',
        analogy: 'Analogy',
        check_understanding: 'Check understanding',
        glossary: 'Key terms',
        custom: 'Custom instruction',
      };

      if(menu){
        menu.querySelectorAll('.ai-menu-item').forEach((item)=>{
          item.addEventListener('click', async (ev)=>{
            ev.preventDefault();
            ev.stopPropagation();
            const action = item.dataset.aiAction || '';
            toggleMenu(false);
            openPanelWithContext(true);
            if(!action || action === 'open_chat') return;
            let txt = getSlideTextForRequest();
            if(!txt){
              // send a short placeholder to trigger server-side slide extraction
              txt = 'slide';
            }
            const label = actionLabels[action] || action;
            if(action === 'adapt_for_audience'){
              const aud = prompt('Adapt for which audience? (e.g., High school students)');
              if(!aud) return;
              await sendAction(action, txt, aud, label);
              return;
            }
            if(action === 'custom'){
              const instruction = prompt('What should the assistant do with the slide text?');
              if(!instruction) return;
              await sendAction(action, txt, null, instruction);
              return;
            }
            await sendAction(action, txt, null, label);
          });
        });
      }

      async function sendAction(action, text, audience, displayMessage){
        
        // show user message (right)
        const userPrompt = displayMessage || buildUserPrompt(action, text, audience);
        appendMessage('user', userPrompt);
        chatHistory.push({ role: 'user', content: userPrompt });
        if(chatHistory.length > maxHistory * 2) chatHistory.splice(0, chatHistory.length - maxHistory * 2);
        // placeholder assistant bubble with typing indicator
        const assistEl = appendMessage('assistant', '');
        if(assistEl){
          assistEl.classList.add('ai-typing');
          assistEl.innerHTML = '<span class="ai-typing-dot"></span><span class="ai-typing-dot"></span><span class="ai-typing-dot"></span>';
        }
        scrollToBottom({ smooth: true });

        function sleep(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }

        try{
          // determine slide index safely (viewer `currentIndex` may be out of scope)
          let slideIndex = 0;
          try{
            if (typeof currentIndex !== 'undefined') slideIndex = currentIndex;
            else {
              const active = document.querySelector('.presentation-thumb.active');
              if(active && active.dataset && typeof active.dataset.index !== 'undefined') slideIndex = parseInt(active.dataset.index, 10) || 0;
            }
          }catch(e){ slideIndex = 0; }
          const body = {
            action: action,
            slide_id: slideIndex,
            slide_text: text,
            user_input: displayMessage || '',
            history: chatHistory.slice(-maxHistory * 2),
          };
          if(action === 'adapt_for_audience' && audience) body.audience = audience;
          const maxRetries = 4;
          let r = null;
          for(let attempt = 0; attempt <= maxRetries; attempt++){
            try{
              r = await fetch(`/api/presentations/${presentationId}/ai/slide`, { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
            }catch(err){
              if(attempt < maxRetries){
                const delay = Math.min(1000 * Math.pow(2, attempt) + 500, 8000);
                if(assistEl){ assistEl.classList.add('ai-typing'); assistEl.textContent = `AI busy. Retrying in ${Math.ceil(delay/1000)}s‚Ä¶`; }
                await sleep(delay);
                continue;
              }
              throw err;
            }

            if(r && r.ok) break;
            const status = r ? r.status : 0;
            if(r && (status === 429 || status === 502 || status === 503) && attempt < maxRetries){
              const retryAfter = parseInt(r.headers.get('Retry-After') || '0', 10);
              const delay = retryAfter ? retryAfter * 1000 : Math.min(1000 * Math.pow(2, attempt) + 500, 8000);
              if(assistEl){ assistEl.classList.add('ai-typing'); assistEl.textContent = `AI busy. Retrying in ${Math.ceil(delay/1000)}s‚Ä¶`; }
              await sleep(delay);
              continue;
            }
            break;
          }

          if(!r || !r.ok){
            // server error: read body for details
            let txt = '';
            try{ txt = await r.text(); txt = txt || (r && r.statusText) || ''; }catch(e){ txt = (r && r.statusText) || String(e); }
            assistEl.textContent = `AI request failed (${r ? r.status : 'no response'}): ${txt || 'no details'}`;
            scrollToBottom({ smooth: true });
            return null;
          }
          let j = null;
          try{
            j = await r.json();
          }catch(e){
            const t = await r.text().catch(()=>null);
            console.error('AI response parse error', e, t);
            assistEl.textContent = `AI response parse error (${e.message}): ${t || 'no body'}`;
            scrollToBottom({ smooth: true });
            return null;
          }
          // replace optimistic suggestion with authoritative server result
          const finalText = (j && j.result) ? j.result : '';
          if(assistEl){
            assistEl.classList.remove('ai-typing');
            if(window.renderAiMarkdown){
              assistEl.innerHTML = window.renderAiMarkdown(finalText || '');
            } else {
              assistEl.textContent = finalText;
            }
          }
          scrollToBottom({ smooth: true });
          if(finalText){
            chatHistory.push({ role: 'assistant', content: finalText });
            if(chatHistory.length > maxHistory * 2) chatHistory.splice(0, chatHistory.length - maxHistory * 2);
          }

          return j.result || null;
        }catch(e){
          console.error('AI slide sendAction error', e);
          if(assistEl){ assistEl.classList.remove('ai-typing'); assistEl.textContent = 'AI request failed'; }
          scrollToBottom({ smooth: true });
          return null;
        }
      }

      sendBtn.addEventListener('click', async ()=>{
        const instruction = (input.value || '').trim();
        if(!instruction){ alert('Please type an instruction for the assistant.'); return; }
        const slideText = getSlideTextForRequest();
        await sendAction('custom', slideText, null, instruction);
        if(input) input.value = '';
      });

      if(input){
        input.addEventListener('keydown', async (e)=>{
          if(e.isComposing) return;
          if(e.key !== 'Enter' || e.shiftKey) return;
          e.preventDefault();
          const instruction = (input.value || '').trim();
          if(!instruction) return;
          const slideText = getSlideTextForRequest();
          await sendAction('custom', slideText, null, instruction);
          input.value = '';
        });
      }

      if(quickActionsEl){
        quickActionsEl.addEventListener('click', async (e)=>{
          const btn = e.target.closest('[data-quick-action]');
          if(!btn) return;
          const kind = btn.getAttribute('data-quick-action');
          const slideText = getSlideTextForRequest() || 'slide';
          if(kind === 'explain'){
            await sendAction('custom', slideText, null, 'Explain this deeper, step by step.');
          }else if(kind === 'example'){
            await sendAction('custom', slideText, null, 'Give a practical example.');
          }else if(kind === 'question'){
            await sendAction('custom', slideText, null, 'Ask me one comprehension question.');
          }
        });
      }
    })();
// Admin preview list (owner only)
(function(){
  const listEl = document.getElementById('admin-preview-list');
  if(!listEl) return;
  async function loadPreviews(){
    listEl.textContent = 'Loading previews‚Ä¶';
    try{
      const r = await fetch(`/presentations/${presentationId}/thumbnails`, { credentials: 'include' });
      if(!r.ok){ listEl.textContent = 'No previews available'; return; }
      const j = await r.json();
      const out = [];
      if(j.thumbnails && j.thumbnails.length){
        j.thumbnails.forEach(u=>{ out.push(`<img src="${u}" alt="thumb" style="max-width:160px;margin-right:6px;margin-bottom:6px;"/>`); });
      }
      // check converted PDF (GET is fine and avoids HEAD 405 issues)
      try{
        const rpGet = await fetch(`/presentations/${presentationId}/converted_pdf?inline=0`, { credentials: 'include' });
        if(rpGet && rpGet.ok){
          out.push(`<div><a href="/presentations/${presentationId}/converted_pdf">Download converted PDF</a></div>`);
        }
      }catch(e){
        // fallback to HEAD check for servers that support it
        try{
          const rpHead = await fetch(`/presentations/${presentationId}/converted_pdf?inline=0`, { method: 'HEAD', credentials: 'include' });
          if(rpHead && rpHead.status === 200){
            out.push(`<div><a href="/presentations/${presentationId}/converted_pdf?inline=1" target="_blank" rel="noopener">Open converted PDF</a></div>`);
          }
        }catch(e2){ /* ignore */ }
      }
      if(out.length) listEl.innerHTML = out.join(''); else listEl.textContent = 'Preview will be ready after conversion.';
    }catch(e){ listEl.textContent = 'Failed to load previews'; }
  }
  loadPreviews();
})();
// Spotify Web Playback SDK integration for presenters who connected Spotify
(function(){
  const playBtn = document.getElementById('spotify-play-btn');
  const status = document.getElementById('spotify-status');
  if(!playBtn) return;
  function toSpotifyUri(url){
    try{
      const u = new URL(url);
      const parts = u.pathname.split('/').filter(Boolean);
      const id = parts.pop();
      const kind = parts.pop();
      if(kind && id) return `spotify:${kind}:${id}`;
    }catch(e){}
    return null;
  }
  playBtn.addEventListener('click', async ()=>{
    status.textContent = 'Initializing‚Ä¶';
    try{
      const res = await fetch('/auth/spotify/token');
      if(!res.ok) throw new Error('not connected');
      const data = await res.json();
      const token = data.access_token;
      // load SDK if needed
      if(!window.Spotify){
        const s = document.createElement('script'); s.src='https://sdk.scdn.co/spotify-player.js'; document.head.appendChild(s);
        await new Promise(r=>{ let t=0; (function wait(){ if(window.Spotify) return r(); t++; if(t>50) return r(); setTimeout(wait,100); })(); });
      }
      const player = new window.Spotify.Player({ name: 'Slideshare Player', getOAuthToken: cb=>cb(token) });
      player.addListener('initialization_error', ({message})=>{ console.error(message); status.textContent='Init error'; });
      player.addListener('authentication_error', ({message})=>{ console.error(message); status.textContent='Auth error'; });
      player.addListener('account_error', ({message})=>{ console.error(message); status.textContent='Account error'; });
      player.addListener('player_state_changed', state=>{ /* no-op */ });
      let deviceId = null;
      player.addListener('ready', ({ device_id }) => { deviceId = device_id; (async ()=>{
        // request play
        const mu = '{{ p.music_url }}';
        const uri = toSpotifyUri(mu);
        if(!uri){ status.textContent='Invalid Spotify URL'; return; }
        try{
          await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, { method: 'PUT', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type':'application/json' }, body: JSON.stringify({ uris: [uri] }) });
          status.textContent='Playing';
        }catch(e){ console.error(e); status.textContent='Playback failed'; }
      })(); });
      await player.connect();
    }catch(e){ console.error(e); status.textContent='Not connected'; }
  });
})();
// Presentation music save/clear handlers
(function(){
  const saveBtn = document.getElementById('presentation-music-save');
  const clearBtn = document.getElementById('presentation-music-clear');
  const input = document.getElementById('presentation-music-input');
  const musicCard = document.getElementById('music-card');
  const musicToggle = document.getElementById('music-toggle-btn');

  // helper: build player markup but do not change visibility
  function buildMusicContent(url){
    if(!musicCard){
      return;
    }
    musicCard.innerHTML = '';
    const trimmed = (url || '').trim();
    if(!trimmed){
      musicCard.style.display = 'none';
      return;
    }
    const lower = trimmed.toLowerCase();
    if(lower.endsWith('.mp3') || lower.endsWith('.m4a') || lower.endsWith('.ogg') || lower.endsWith('.wav')){
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.style.width = '100%';
      audio.style.maxWidth = '680px';
      const src = document.createElement('source');
      src.src = trimmed;
      audio.appendChild(src);
      audio.appendChild(document.createTextNode('Your browser does not support the audio element.'));
      musicCard.appendChild(audio);
    }else if(trimmed.includes('spotify.com')){
      const iframe = document.createElement('iframe');
      iframe.style.borderRadius = '12px';
      iframe.style.width = '100%';
      iframe.style.maxWidth = '680px';
      iframe.style.height = '152px';
      iframe.src = trimmed.replace('open.spotify.com/', 'open.spotify.com/embed/');
      iframe.frameBorder = '0';
      iframe.allow = 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture';
      iframe.loading = 'lazy';
      musicCard.appendChild(iframe);
    }else{
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.style.width = '100%';
      audio.style.maxWidth = '680px';
      audio.src = trimmed;
      audio.appendChild(document.createTextNode('Your browser does not support the audio element.'));
      musicCard.appendChild(audio);
    }
  }

  if(musicToggle && musicCard){
    musicToggle.addEventListener('click', ()=>{
      const visible = musicCard.style.display !== 'none';
      if(visible){
        musicCard.style.display = 'none';
      }else{
        // lazily build content from current input value if empty
        if(!musicCard.innerHTML.trim() && input && input.value.trim()){
          buildMusicContent(input.value.trim());
        }
        musicCard.style.display = '';
      }
    });
  }

  if(!saveBtn || !input) return;
  saveBtn.addEventListener('click', async ()=>{
    try{
      const url = input.value.trim();
      const res = await fetch(`/presentations/{{ p.id }}/music`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ music_url: url }) });
      if(!res.ok) throw new Error('save failed');
      // update underlying content but do not auto-open; user controls via music icon
      buildMusicContent(url);
    }catch(e){ alert('Failed to save music'); }
  });
  if(clearBtn){
    clearBtn.addEventListener('click', async ()=>{
      try{
        const res = await fetch(`/presentations/{{ p.id }}/music`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ music_url: '' }) });
        if(!res.ok) throw new Error('clear failed');
        input.value = '';
        buildMusicContent('');
      }catch(e){ alert('Failed to clear music'); }
    });
  }
})();

// Delete presentation modal (owner only)
(function(){
  const trigger = document.getElementById('delete-presentation-btn');
  const modal = document.getElementById('delete-modal');
  const cancel = document.getElementById('delete-cancel-btn');
  if(!trigger || !modal || !cancel) return;
  trigger.addEventListener('click', ()=>{
    modal.style.display = 'flex';
  });
  cancel.addEventListener('click', ()=>{
    modal.style.display = 'none';
  });
  modal.addEventListener('click', (e)=>{
    if(e.target === modal){
      modal.style.display = 'none';
    }
  });
})();
</script>
{% endblock %}
