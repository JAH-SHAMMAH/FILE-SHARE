{% extends "base.html" %}
{% block content %}
<div class="container content-card presentation-detail">
  <div class="presentation-wrap">
    <div class="presentation">
      <div class="presentation-header">
        <div>
          <h1>{{ p.title }}</h1>
          <p class="muted">by {% if p.owner_username %}<a href="/users/{{ p.owner_username }}">{{ p.owner_username }}</a>{% else %}{{ p.author or 'Unknown' }}{% endif %} · {{ p.views or 0 }} views</p>
        </div>
        <div class="presentation-actions">
          {% if original_url %}
          <a class="btn" href="{{ original_url }}" download>Download original</a>
          {% endif %}
          <a class="btn btn--ghost" href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.url_for('view_presentation', presentation_id=p.id) }}" target="_blank">Share</a>

          <!-- Bookmark button + saved count -->
          <button id="bookmark-btn" class="bookmark-btn" data-id="{{ p.id }}" aria-pressed="{{ 'true' if is_bookmarked else 'false' }}">
            <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 2h12a1 1 0 0 1 1 1v18l-7-4-7 4V3a1 1 0 0 1 1-1z"/></svg>
            <span id="bookmark-count" class="bookmark-count">{{ bookmarks_count or 0 }}</span>
          </button>

          {% if p.owner_id %}
            <button class="btn btn--ghost btn-contact" data-user-id="{{ p.owner_id }}" data-username="{{ p.owner_username or p.author }}" data-email="{{ p.owner_email or '' }}">Contact Owner</button>
            <button class="btn btn--ghost btn-message" data-user-id="{{ p.owner_id }}" data-username="{{ p.owner_username or p.author }}">Message <span class="msg-badge" data-user-id="{{ p.owner_id }}"></span></button>
            <span class="presence-dot" data-user-id="{{ p.owner_id }}" style="margin-left:6px;width:8px;height:8px;border-radius:50%;background:#ccc;display:inline-block"></span>

            {% if is_following %}
              <form class="follow-form" data-owner-id="{{ p.owner_id }}" method="post" action="/users/{{ p.owner_id }}/unfollow" style="display:inline">
                <button class="btn btn--ghost btn-follow">Unsubscribe</button>
              </form>
            {% else %}
              <form class="follow-form" data-owner-id="{{ p.owner_id }}" method="post" action="/users/{{ p.owner_id }}/follow" style="display:inline">
                <button class="btn btn--ghost btn-follow">Subscribe</button>
              </form>
            {% endif %}

            <span class="muted followers-count" data-owner-id="{{ p.owner_id }}" style="margin-left:8px; font-size:13px;">{{ followers_count or 0 }} followers</span>

            <form method="post" action="/presentations/{{ p.id }}/buy" style="display:inline">
              <button class="btn btn--ghost">Buy</button>
            </form>
          {% elif p.owner_email %}
            <button class="btn btn--ghost btn-contact" data-user-id="" data-username="" data-email="{{ p.owner_email }}">Contact Owner</button>
          {% endif %}
        </div>
      </div>

      <div class="viewer-box">
        {% if viewer_url %}
          <div class="preview-frame-box preview-frame-box--wide" id="presentation-preview">
            <div class="preview-placeholder" id="presentation-placeholder">
              <div class="pill pill--tiny">Preview</div>
              <p class="muted" style="margin:8px 0 0 0;">Loading the first page…</p>
            </div>
            <canvas id="presentation-canvas" class="file-preview file-preview--canvas" aria-label="Presentation canvas" style="display:none;"></canvas>
            <object id="presentation-object" class="file-preview" data="{{ viewer_url }}{% if '#' not in viewer_url %}#page=1&view=FitH&toolbar=1&navpanes=0{% endif %}" type="application/pdf" aria-label="Presentation preview" style="width:100%;height:720px;border-radius:12px;box-shadow:0 10px 24px rgba(15,23,42,0.18); background:#fff;"></object>
            <div class="preview-toolbar">
              <span class="muted" id="presentation-status">Loading…</span>
            </div>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <a class="btn" id="presentation-open" href="{{ viewer_url }}" target="_blank" rel="noopener">Open PDF</a>
            {% if original_url and original_url != viewer_url %}
            <a class="btn btn--ghost" href="{{ original_url }}" download>Download original</a>
            {% endif %}
          </div>
        {% elif p.filename %}
          <div class="fallback-box">
            <img src="{{ request.url_for('static', path='slide-placeholder.svg') }}" alt="slide preview" style="width:100%;height:auto;border-radius:12px;box-shadow:0 10px 24px rgba(15,23,42,0.12);" />
            {% if conversion_status == 'queued' %}
              <p class="muted" style="margin-top:8px;">Converting to PDF for inline view. Refresh in a moment or download the original now.</p>
            {% elif conversion_status == 'failed' %}
              <p class="muted" style="margin-top:8px;">Conversion failed. Use Download to view the original file.</p>
            {% else %}
              <p class="muted" style="margin-top:8px;">Preview not available for this file type. Use Download to view the original. Content remains view-only.</p>
            {% endif %}
            {% if original_url %}
              <div style="margin-top:10px;"><a class="btn" href="{{ original_url }}" download>Download original</a></div>
            {% endif %}
          </div>
        {% else %}
          <img src="{{ request.url_for('static', path='slide-placeholder.svg') }}" alt="slide preview" style="width:100%;height:auto;border-radius:12px;box-shadow:0 10px 24px rgba(15,23,42,0.12);" />
        {% endif %}
      </div>
    </div>

    <aside class="presentation-side">
      <div class="box">
        <h4>Actions</h4>
        {% if p.filename %}
        <a class="btn" href="/download/{{ p.filename }}" download>Download</a>
        {% endif %}
        <form method="post" action="/presentations/{{ p.id }}/like" style="display:inline">
          <button class="btn btn--ghost" type="submit">Like ({{ likes }})</button>
        </form>
      </div>

      <div class="box">
        <h4>Share</h4>
        <a href="https://twitter.com/intent/tweet?url={{ request.url_for('view_presentation', presentation_id=p.id) }}" target="_blank" class="btn btn--ghost">Twitter</a>
        <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.url_for('view_presentation', presentation_id=p.id) }}" target="_blank" class="btn btn--ghost">LinkedIn</a>
      </div>
    </aside>
  </div>

  <div class="presentation-desc">
    <h3>About this presentation</h3>
    <p>{{ p.description or 'No description provided.' }}</p>
  </div>

  <section class="comments">
    <h3>Comments</h3>
    <ul>
      {% for c in comments %}
      <li>
        <strong>{{ comment_users.get(c.user_id) or ('User #' ~ c.user_id) }}</strong>
        <small class="muted">{{ c.created_at.strftime('%Y-%m-%d') }}</small>
        <div>{{ c.content }}</div>
      </li>
      {% else %}
      <li>No comments yet.</li>
      {% endfor %}
    </ul>
    <form method="post" action="/presentations/{{ p.id }}/comment">
      <textarea name="content" required placeholder="Add a public comment" rows="4"></textarea>
      <div class="auth-actions"><button class="btn">Post comment</button></div>
    </form>
  </section>
</div>
{% endblock %}

{% block scripts %}
  <script>
    if (window.pdfjsLib) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = "/static/js/pdf.worker.min.js";
      window.pdfjsLib.disableWorker = false;
    }
    (async () => {
      const canvas = document.getElementById("presentation-canvas");
      const objectEl = document.getElementById("presentation-object");
      const placeholder = document.getElementById("presentation-placeholder");
      const statusEl = document.getElementById("presentation-status");
      const openBtn = document.getElementById("presentation-open");
      let blobUrl = null;

      const setStatus = (msg) => {
        if (statusEl) statusEl.textContent = msg || "";
      };

      const showObject = () => {
        if (objectEl) {
          objectEl.style.display = "block";
          if (placeholder) placeholder.style.display = "none";
        }
      };

      if (!objectEl) return;
      const viewerUrl = objectEl.getAttribute("data") || objectEl.getAttribute("src");
      if (!viewerUrl) {
        setStatus("Preview unavailable");
        return;
      }

      const cleanUrl = viewerUrl.split("#")[0];
      try {
        setStatus("Loading preview…");
        const res = await fetch(cleanUrl);
        if (!res.ok) throw new Error("Fetch failed");
        const bytes = await res.arrayBuffer();
        blobUrl = URL.createObjectURL(new Blob([bytes], { type: "application/pdf" }));

        // Use blob URL to avoid download prompts and keep viewer same-origin.
        objectEl.setAttribute("data", `${blobUrl}#toolbar=1&navpanes=0&view=FitH`);
        showObject();
        if (openBtn) openBtn.href = blobUrl;

        if (canvas && window.pdfjsLib) {
          const pdf = await window.pdfjsLib.getDocument({ data: bytes }).promise;
          const page = await pdf.getPage(1);
          const viewport = page.getViewport({ scale: 1 });
          const boxWidth = canvas.parentElement ? canvas.parentElement.clientWidth || viewport.width : viewport.width;
          const scale = Math.min(boxWidth / viewport.width, 1.6);
          const scaled = page.getViewport({ scale: scale > 0 ? scale : 1 });
          const ctx = canvas.getContext("2d");
          canvas.width = scaled.width;
          canvas.height = scaled.height;
          await page.render({ canvasContext: ctx, viewport: scaled }).promise;
          canvas.style.display = "block";
          objectEl.style.display = "none";
          if (placeholder) placeholder.style.display = "none";
          setStatus(`Page 1 of ${pdf.numPages || 1}`);
        } else {
          setStatus("");
        }
      } catch (err) {
        console.error("presentation preview failed", err);
        showObject();
        setStatus("Preview blocked — use Open PDF");
      }

      window.addEventListener("beforeunload", () => {
        if (blobUrl) URL.revokeObjectURL(blobUrl);
      });
    })();
  </script>
    <script>
      if (window.pdfjsLib) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = "/static/js/pdf.worker.min.js";
        window.pdfjsLib.disableWorker = false;
      }
    </script>
{% endblock %}
