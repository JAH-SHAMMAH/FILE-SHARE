{% extends 'base.html' %}
{% block title %}{{ classroom.name }} — Attendance{% endblock %}

{% block content %}
  <section class="container" style="max-width:980px;margin-top:18px;">
    <div class="content-card" style="padding:18px;">
      <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;">
        <div>
          <h1 style="margin:0 0 6px 0;">Attendance — {{ classroom.name }}</h1>
          <p class="muted" style="margin:0;">Mark attendance for each student.</p>
        </div>
        <a class="btn btn--ghost" href="/classrooms/{{ classroom.id }}/view">Back to classroom</a>
      </div>

      {% if members %}
        <form id="attendance-form" style="margin-top:14px;">
          <div class="content-card" style="padding:12px;border:1px solid var(--border);">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);">Student</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);">Status</th>
                </tr>
              </thead>
              <tbody>
              {% for m in members %}
                {% if m.role == 'student' %}
                <tr>
                  <td style="padding:8px;border-bottom:1px solid var(--border);">{{ m.username or m.user_id }}</td>
                  <td style="padding:8px;border-bottom:1px solid var(--border);">
                    <select name="status_{{ m.user_id }}" style="padding:6px 8px;border-radius:8px;border:1px solid var(--border);">
                      <option value="present">Present</option>
                      <option value="absent">Absent</option>
                      <option value="late">Late</option>
                    </select>
                  </td>
                </tr>
                {% endif %}
              {% endfor %}
              </tbody>
            </table>
            <div style="display:flex;justify-content:flex-end;margin-top:10px;">
              <button id="submit-attendance" class="btn" type="button">Save Attendance</button>
            </div>
          </div>
        </form>
      {% else %}
        <p class="muted" style="margin-top:12px;">No members found for this classroom.</p>
      {% endif %}
    </div>
  </section>

  <script>
    document.getElementById('submit-attendance')?.addEventListener('click', async function(){
      const entries = [];
      const form = document.getElementById('attendance-form');
      if(!form) return;
      for(const el of form.querySelectorAll('select')){
        const name = el.name; // status_<id>
        const user_id = parseInt(name.split('_')[1], 10);
        entries.push({user_id: user_id, status: el.value});
      }
      try{
        const token = (document.cookie.match('(^|;)\\s*csrf_token\\s*=\\s*([^;]+)')||[]).pop() || '';
        const res = await fetch('/api/classrooms/{{ classroom.id }}/attendance', {
          method: 'POST',
          headers: {'Content-Type':'application/json', 'X-CSRF-Token': token},
          body: JSON.stringify({entries: entries})
        });
        const j = await res.json();
        if(j.ok) {
          alert('Attendance saved');
          window.location.reload();
        } else {
          alert('Failed to save attendance');
        }
      } catch(e){
        alert('Error saving attendance: '+e);
      }
    });
  </script>
{% endblock %}