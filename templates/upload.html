{% extends "base.html" %}
{% block head %}
  <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
{% endblock %}

{% block scripts %}
  <script>
    if (window.pdfjsLib) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js";
      window.pdfjsLib.disableWorker = false;
    }
  </script>
{% endblock %}

{% block content %}
{% set is_premium = current_user and current_user.is_premium %}

<section class="content-card upload-hero upload-hero--lite">
  <h1 class="upload-title">Let’s get your document ready for the spotlight.</h1>
  <p class="muted">The details on this page help your documents be easily found.</p>
</section>

<section class="upload-shell upload-shell--slim" id="upload-form">
  <form method="post" enctype="multipart/form-data" class="upload-layout upload-form" id="upload-form-el">
    <div class="preview-stack">
      <div class="preview-frame-box preview-frame-box--tight" id="file-preview-box">
        <div class="preview-placeholder" id="file-preview-placeholder">
          <div class="pill pill--tiny">Preview</div>
          <p class="muted" style="margin:8px 0 0 0;">Your first page will appear here</p>
        </div>
        <canvas id="file-preview-canvas" class="file-preview file-preview--canvas" aria-label="File preview canvas"></canvas>
        <object id="file-preview-frame" class="file-preview" type="application/pdf" aria-label="File preview"></object>
        <div class="preview-toolbar">
          <span class="muted" id="preview-page-label">1 of ?</span>
          <div class="preview-actions-inline">
            <button type="button" class="icon-btn" id="preview-zoom">↕</button>
          </div>
        </div>
      </div>
      <label class="field" style="margin-top:12px;">
        <div class="dropzone dropzone--tight">
          <div>
            <p class="muted" style="margin:0;">Drag & drop or</p>
            <strong id="file-name">browse your computer</strong>
          </div>
          <input id="file-input" name="file" type="file" accept=".pdf,.ppt,.pptx,.pptm" required aria-label="Select file to upload" />
        </div>
      </label>
    </div>

    <div class="upload-form-panel content-card">
      {% if error %}
      <div class="alert alert-error" style="margin-bottom:12px;">{{ error }}</div>
      {% endif %}

      <label class="field">Title*<input name="title" id="title-input" required placeholder="Minimum 40 characters" /></label>
      <label class="field">Description*<textarea name="description" id="desc-input" rows="6" placeholder="Briefly summarize the main points. Short, simple sentences with a few keywords are best."></textarea></label>

      {% if is_premium %}
      <div class="ai-block" style="margin-bottom:12px;">
        <div class="pill pill--tiny">Premium AI</div>
        <h4 style="margin:8px 0 6px 0;">Refine your slides faster</h4>
        <p class="muted" style="margin:0 0 8px 0;">Paste a slide or summary and let AI rewrite, rephrase, or simplify it before you publish.</p>
        <textarea id="ai-input" rows="4" placeholder="Paste slide text to improve"></textarea>
        <div class="auth-actions" style="margin-top:8px; gap:8px; justify-content:flex-start;">
          <button class="btn" type="button" data-ai-mode="rewrite">Rewrite</button>
          <button class="btn btn--ghost" type="button" data-ai-mode="rephrase">Rephrase</button>
          <button class="btn btn--ghost" type="button" data-ai-mode="simplify">Simplify</button>
        </div>
        <div class="ai-output" id="ai-output"></div>
        <p class="muted" style="font-size:12px; margin-top:6px;">You can edit the result and drop it into the description.</p>
      </div>
      {% else %}
      <div class="ai-upgrade" style="margin-bottom:12px;">
        <div class="pill pill--tiny">Premium</div>
        <p style="margin:6px 0 4px 0; font-weight:700;">Unlock AI writing assistance.</p>
        <p class="muted" style="margin:0 0 10px 0;">Rewrite, rephrase, or simplify slide content instantly—right inside the upload form.</p>
        <a class="btn" href="/premium/subscribe">Upgrade to premium</a>
      </div>
      {% endif %}

      <div class="meta-grid meta-grid--compact">
        <label class="field">Category*
          <select name="category" required>
            <option value="">Select a category</option>
            <option value="school">School</option>
            <option value="politics">Politics</option>
            <option value="society">Society</option>
            <option value="technology">Technology</option>
            <option value="business">Business</option>
            <option value="design">Design</option>
            <option value="marketing">Marketing</option>
            {% for c in categories %}
            <option value="{{ c.name }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="field">Tags
          <input name="tags" placeholder="Add up to 20 keywords" />
        </label>
      </div>

      <div class="meta-grid meta-grid--compact">
        <label class="field">Privacy
          <select name="privacy">
            <option value="public">Public</option>
            <option value="private">Private</option>
          </select>
        </label>
        <label class="field">License
          <select name="license">
            <option value="all_rights_reserved">All Rights Reserved</option>
            <option value="cc_by">CC BY</option>
            <option value="cc_by_sa">CC BY-SA</option>
          </select>
        </label>
      </div>

      <div class="toggle-row">
        <label class="toggle">
          <input type="checkbox" name="allow_download" value="1" checked />
          <span>Allow people to download this document</span>
        </label>
        <label class="toggle">
          <input type="checkbox" name="allow_embed" value="1" checked />
          <span>Allow people to embed this document</span>
        </label>
      </div>

      <div class="auth-actions" style="justify-content:flex-end; gap:10px; margin-top:10px;">
        <a class="btn btn--ghost" href="/">Cancel</a>
        <button class="btn" type="submit">Publish</button>
      </div>
    </div>
  </form>
</section>

{% endblock %}
