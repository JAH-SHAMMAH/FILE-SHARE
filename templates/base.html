<!DOCTYPE html>
{% set ui_lang = request.cookies.get('ui_lang', 'en') if request and request.cookies else 'en' %}
<html lang="{{ ui_lang }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}247FileShare{% endblock %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="{{ request.url_for('static', path='favicon.png') }}" />
  <link rel="stylesheet" href="{{ request.url_for('static', path='styles.css') }}?v={{ request.state.static_version }}" />
  <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
  {% block head %}{% endblock %}
</head>
<body class="{% if request.state.current_user and request.state.current_user.site_role == 'teacher' %}role-teacher{% endif %}">
  <header class="site-header">
    <div class="container header-inner">
      <div class="header-left" style="display:flex;align-items:center;gap:12px;">
        <a href="{{ url_for('index') }}" class="brand">
          <span class="brand-text">247FileShare</span>
        </a>
      </div>

      <nav class="header-nav">
        <div class="nav-cta" style="display:flex;align-items:center;gap:10px;">
          {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f310.svg' %}
          {% if ui_lang == 'en' %}
            {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f1fa-1f1f8.svg' %}
          {% elif ui_lang == 'es' %}
            {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f1ea-1f1f8.svg' %}
          {% elif ui_lang == 'fr' %}
            {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f1eb-1f1f7.svg' %}
          {% elif ui_lang == 'pt' %}
            {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f1e7-1f1f7.svg' %}
          {% elif ui_lang == 'de' %}
            {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f1e9-1f1ea.svg' %}
          {% elif ui_lang == 'ar' %}
            {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f1f8-1f1e6.svg' %}
          {% elif ui_lang == 'hi' %}
            {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f1ee-1f1f3.svg' %}
          {% elif ui_lang == 'zh' %}
            {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f1e8-1f1f3.svg' %}
          {% elif ui_lang == 'ja' %}
            {% set lang_flag_img = 'https://twemoji.maxcdn.com/v/latest/svg/1f1ef-1f1f5.svg' %}
          {% endif %}
          <div class="nav-link small lang-switcher" id="lang-switcher" title="Language" style="position:relative;">
            <button class="lang-button" type="button" aria-haspopup="true" aria-expanded="false">
              <img class="lang-flag" id="lang-flag" alt="" src="{{ lang_flag_img }}" />
              <span class="lang-code" id="lang-code">{{ ui_lang|upper }}</span>
            </button>
            <div class="lang-dropdown" id="lang-dropdown">
              <button type="button" data-lang="en" data-flag="ğŸ‡ºğŸ‡¸" data-flag-alt="ğŸ‡¬ğŸ‡§">English</button>
              <button type="button" data-lang="es" data-flag="ğŸ‡ªğŸ‡¸">EspaÃ±ol</button>
              <button type="button" data-lang="fr" data-flag="ğŸ‡«ğŸ‡·">FranÃ§ais</button>
              <button type="button" data-lang="pt" data-flag="ğŸ‡§ğŸ‡·">PortuguÃªs</button>
              <button type="button" data-lang="de" data-flag="ğŸ‡©ğŸ‡ª">Deutsch</button>
              <button type="button" data-lang="ar" data-flag="ğŸ‡¸ğŸ‡¦">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
              <button type="button" data-lang="hi" data-flag="ğŸ‡®ğŸ‡³">à¤¹à¤¿à¤¨à¥à¤¦à¥€</button>
              <button type="button" data-lang="zh" data-flag="ğŸ‡¨ğŸ‡³">ä¸­æ–‡</button>
              <button type="button" data-lang="ja" data-flag="ğŸ‡¯ğŸ‡µ">æ—¥æœ¬èª</button>
            </div>
          </div>
          {% if ui_lang == 'fr' %}
            {% set t_featured = 'Ã€ la une' %}
            {% set t_teaching = 'Enseignement' %}
            {% set t_messages = 'Messages' %}
            {% set t_upload = 'TÃ©lÃ©verser' %}
            {% set t_login = 'Connexion' %}
            {% set t_signup = "Start" %}
            {% set t_help = 'Aide' %}
            {% set t_contact = 'Contact' %}
            {% set t_terms = 'Conditions' %}
            {% set t_privacy = 'ConfidentialitÃ©' %}
          {% elif ui_lang == 'es' %}
            {% set t_featured = 'Destacados' %}
            {% set t_teaching = 'EnseÃ±ar' %}
            {% set t_classrooms = 'Aulas' %}
            {% set t_materials = 'Materiales' %}
            {% set t_messages = 'Mensajes' %}
            {% set t_upload = 'Subir' %}
            {% set t_login = 'Iniciar sesiÃ³n' %}
            {% set t_signup = 'Start' %}
            {% set t_help = 'Ayuda' %}
            {% set t_contact = 'Contacto' %}
            {% set t_terms = 'TÃ©rminos' %}
            {% set t_privacy = 'Privacidad' %}
          {% elif ui_lang == 'pt' %}
            {% set t_featured = 'Em destaque' %}
            {% set t_teaching = 'Ensino' %}
            {% set t_classrooms = 'Turmas' %}
            {% set t_materials = 'Materiais' %}
            {% set t_messages = 'Mensagens' %}
            {% set t_upload = 'Enviar' %}
            {% set t_login = 'Entrar' %}
            {% set t_signup = 'Start' %}
            {% set t_help = 'Ajuda' %}
            {% set t_contact = 'Contato' %}
            {% set t_terms = 'Termos' %}
            {% set t_privacy = 'Privacidade' %}
          {% elif ui_lang == 'de' %}
            {% set t_featured = 'Highlights' %}
            {% set t_teaching = 'Unterrichten' %}
            {% set t_classrooms = 'Klassen' %}
            {% set t_materials = 'Materialien' %}
            {% set t_messages = 'Nachrichten' %}
            {% set t_upload = 'Hochladen' %}
            {% set t_login = 'Anmelden' %}
            {% set t_signup = 'Start' %}
            {% set t_help = 'Hilfe' %}
            {% set t_contact = 'Kontakt' %}
            {% set t_terms = 'Bedingungen' %}
            {% set t_privacy = 'Datenschutz' %}
          {% elif ui_lang == 'ar' %}
            {% set t_featured = 'Ù…Ù…ÙŠØ²' %}
            {% set t_teaching = 'Ø§Ù„ØªØ¹Ù„ÙŠÙ…' %}
            {% set t_classrooms = 'Ø§Ù„ÙØµÙˆÙ„' %}
            {% set t_materials = 'Ø§Ù„Ù…ÙˆØ§Ø¯' %}
            {% set t_messages = 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„' %}
            {% set t_upload = 'Ø±ÙØ¹' %}
            {% set t_login = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' %}
            {% set t_signup = 'Start' %}
            {% set t_help = 'Ù…Ø³Ø§Ø¹Ø¯Ø©' %}
            {% set t_contact = 'Ø§ØªØµØ§Ù„' %}
            {% set t_terms = 'Ø§Ù„Ø´Ø±ÙˆØ·' %}
            {% set t_privacy = 'Ø§Ù„Ø®ØµÙˆØµÙŠØ©' %}
          {% elif ui_lang == 'hi' %}
            {% set t_featured = 'à¤µà¤¿à¤¶à¥‡à¤·' %}
            {% set t_teaching = 'à¤¶à¤¿à¤•à¥à¤·à¤£' %}
            {% set t_classrooms = 'à¤•à¤•à¥à¤·à¤¾à¤à¤' %}
            {% set t_materials = 'à¤¸à¤¾à¤®à¤—à¥à¤°à¥€' %}
            {% set t_messages = 'à¤¸à¤‚à¤¦à¥‡à¤¶' %}
            {% set t_upload = 'à¤…à¤ªà¤²à¥‹à¤¡' %}
            {% set t_login = 'à¤²à¥‰à¤—à¤¿à¤¨' %}
            {% set t_signup = 'Start' %}
            {% set t_help = 'à¤®à¤¦à¤¦' %}
            {% set t_contact = 'à¤¸à¤‚à¤ªà¤°à¥à¤•' %}
            {% set t_terms = 'à¤¶à¤°à¥à¤¤à¥‡à¤‚' %}
            {% set t_privacy = 'à¤—à¥‹à¤ªà¤¨à¥€à¤¯à¤¤à¤¾' %}
          {% elif ui_lang == 'zh' %}
            {% set t_featured = 'ç²¾é€‰' %}
            {% set t_teaching = 'æ•™å­¦' %}
            {% set t_classrooms = 'è¯¾å ‚' %}
            {% set t_materials = 'èµ„æ–™' %}
            {% set t_messages = 'æ¶ˆæ¯' %}
            {% set t_upload = 'ä¸Šä¼ ' %}
            {% set t_login = 'ç™»å½•' %}
            {% set t_signup = 'Start' %}
            {% set t_help = 'å¸®åŠ©' %}
            {% set t_contact = 'è”ç³»' %}
            {% set t_terms = 'æ¡æ¬¾' %}
            {% set t_privacy = 'éšç§' %}
          {% elif ui_lang == 'ja' %}
            {% set t_featured = 'æ³¨ç›®' %}
            {% set t_teaching = 'æ•™è‚²' %}
            {% set t_classrooms = 'æ•™å®¤' %}
            {% set t_materials = 'æ•™æ' %}
            {% set t_messages = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸' %}
            {% set t_upload = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰' %}
            {% set t_login = 'ãƒ­ã‚°ã‚¤ãƒ³' %}
            {% set t_signup = 'Start' %}
            {% set t_help = 'ãƒ˜ãƒ«ãƒ—' %}
            {% set t_contact = 'ãŠå•ã„åˆã‚ã›' %}
            {% set t_terms = 'åˆ©ç”¨è¦ç´„' %}
            {% set t_privacy = 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼' %}
          {% else %}
            {% set t_featured = 'Featured' %}
            {% set t_teaching = 'Teaching' %}
            {% set t_classrooms = 'Classrooms' %}
            {% set t_materials = 'Materials' %}
            {% set t_messages = 'Messages' %}
            {% set t_upload = 'Upload' %}
            {% set t_login = 'Login' %}
            {% set t_signup = 'Start' %}
            {% set t_help = 'Help' %}
            {% set t_contact = 'Contact' %}
            {% set t_terms = 'Terms' %}
            {% set t_privacy = 'Privacy' %}
          {% endif %}

          {% set cu = request.state.current_user if request and request.state else None %}
          <div class="header-primary-links">
            {% if cu %}
            <a class="nav-link" href="{{ url_for('student_spaces') }}">My Spaces</a>
            {% if request.state.current_user and request.state.current_user.site_role != 'teacher' %}
            <a class="nav-link" href="{{ url_for('student_materials') }}">Materials</a>
            {% endif %}
            {% if cu.site_role == 'teacher' %}
            <a class="nav-link" href="{{ url_for('teacher_dashboard') }}">{{ t_teaching }}</a>
            {% endif %}
            <a class="nav-link" href="{{ url_for('messages_page') }}">
              {{ t_messages }}
              <span id="messages-badge" style="display:none;margin-left:4px;background:#ff3b30;color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;">0</span>
            </a>
          {% else %}
            <a class="nav-link" href="{{ url_for('about') }}">About us</a>
            <a class="nav-link" href="{{ url_for('upload') }}">{{ t_upload }}</a>
            <a class="nav-link" href="{{ url_for('login') }}">Sign in</a>
            <a class="nav-link btn" href="{{ url_for('register') }}">Get started</a>
          {% endif %}
          </div>
        </div>

        <button id="hamburger" class="hamburger" aria-label="Open menu" aria-expanded="false">â˜°</button>

        {% if request.state.current_user %}
          <button class="profile-trigger avatar-button header-profile-trigger" type="button" aria-haspopup="true" aria-expanded="false" title="Open profile menu">
            <span class="header-profile-name">{{ request.state.current_user.username }}</span>
            <div class="avatar-badge">{{ request.state.current_user.username[:2].upper() if request.state.current_user.username else 'ME' }}</div>
          </button>
          <button id="notif-launcher" class="icon-btn" title="Notifications" style="position:relative;margin-left:6px">ğŸ””<span id="notif-badge" style="position:absolute;right:-6px;top:-6px;background:#ff3b30;color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;display:none">0</span></button>
          <div class="profile-menu">
            <div class="profile-menu__head">
              <button class="profile-trigger avatar-button" type="button" aria-haspopup="true" aria-expanded="false" title="Open profile menu">
                <div class="avatar-badge">{{ request.state.current_user.username[:2].upper() if request.state.current_user.username else 'ME' }}</div>
              </button>
              <div>
                <div class="profile-menu__name">{{ request.state.current_user.username }}</div>
                <div class="profile-menu__email">{{ request.state.current_user.email or '' }}</div>
              </div>
            </div>
            <a class="profile-menu__item" href="{{ url_for('profile_view', username=request.state.current_user.username) }}">View Profile</a>
            <a class="profile-menu__item" href="{{ url_for('bookmarks_view') }}">Saved</a>
            <a class="profile-menu__item" href="{{ url_for('upload') }}">My Uploads</a>
            {% if ADMIN_USERNAME and request.state.current_user.username == ADMIN_USERNAME %}
            <a class="profile-menu__item" href="{{ url_for('admin_import_page') }}">Admin: Import</a>
            {% endif %}
            {% if request.state.current_user.is_premium %}
            <a class="profile-menu__item" href="{{ url_for('premium_dashboard') }}">Premium Dashboard</a>
            {% else %}
            <a class="profile-menu__item" href="{{ url_for('premium_subscribe') }}">Upgrade to Premium</a>
            {% endif %}
            {% if request.state.current_user.spotify_refresh_token %}
            <div class="profile-menu__item" style="cursor:default">Spotify connected</div>
            {% else %}
            <a class="profile-menu__item" href="{{ url_for('spotify_login') }}">Connect Spotify</a>
            {% endif %}
            <a class="profile-menu__item" href="{{ url_for('account_settings_get') }}">Account Settings</a>
            <a class="profile-menu__item" href="{{ url_for('help') }}">Support</a>
            <div class="profile-menu__divider"></div>
            <a class="profile-menu__item" href="{{ url_for('logout') }}">Logout</a>
          </div>
        {% endif %}

        <div id="hamburger-menu" class="hamburger-menu" aria-hidden="true">
          <div class="hamburger-menu__inner">
            <div class="hamburger-menu__section">
              <h4>Navigation</h4>
              <ul>
                {% if cu %}
                <li><a href="{{ url_for('student_spaces') }}">My Spaces</a></li>
                {% if request.state.current_user and request.state.current_user.site_role != 'teacher' %}
                <li><a href="{{ url_for('student_materials') }}">Materials</a></li>
                {% endif %}
                {% if cu.site_role == 'teacher' %}
                <li><a href="{{ url_for('teacher_dashboard') }}">{{ t_teaching }}</a></li>
                {% endif %}
                <li><a href="{{ url_for('messages_page') }}">{{ t_messages }}</a></li>
                {% else %}
                <li><a href="{{ url_for('about') }}">About us</a></li>
                <li><a href="{{ url_for('upload') }}">{{ t_upload }}</a></li>
                <li><a href="{{ url_for('login') }}">Sign in</a></li>
                <li><a href="{{ url_for('register') }}">Get started</a></li>
                {% endif %}
              </ul>
            </div>

            {% if request.state.current_user %}
            <div class="hamburger-menu__divider"></div>
            <div class="hamburger-menu__section">
              <h4>Your account</h4>
              <ul>
                <li><a href="{{ url_for('profile_view', username=request.state.current_user.username) }}">View profile</a></li>
                <li><a href="{{ url_for('account_settings_get') }}#role-settings">Change role / view</a></li>
              </ul>
            </div>
            {% endif %}
          </div>
        </div>
      </nav>
    </div>
  </header>

  {# Global category chips under the header, only on Featured page #}
  {% set current_path = request.url.path if request and request.url else '' %}
  {% if request.state.categories and current_path == '/featured' %}
  <section class="container category-bar" style="margin-top:8px;">
    <div style="display:flex;align-items:center;justify-content:flex-start;gap:12px;flex-wrap:nowrap;">
      {% set removed_cats = ['for you','business','mobile','marketing','technology','school','society'] %}
      {% set suggested = ['For You'] %}
      {% set suggested_lower = suggested | map('lower') | list %}
      {% if suggested|length %}
      <div class="suggested-chips">
        {% for s in suggested %}
          {% set is_for_you = (s == 'For You') %}
          {% if is_for_you %}
            {% set active_for_you = (current_path == '/featured') or ((request.query_params.get('category') or 'For You') == 'For You') %}
            <a class="suggested-chip{% if active_for_you %} active{% endif %}" href="{{ url_for('featured') }}">{{ s }}</a>
          {% else %}
            {% set active_cat = (s == request.query_params.get('category')) %}
            <a class="suggested-chip{% if active_cat %} active{% endif %}" href="/search?category={{ s|url_encode }}">{{ s }}</a>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
      <div style="display:flex;align-items:center;justify-content:flex-start;gap:12px;">
        <div id="category-scroll" class="category-scroll" role="list">
          {% set ns = namespace(seen=[]) %}
          {% set visible_limit = 7 %}
          {% for c in request.state.categories or [] %}
            {% set c_lower = c|lower %}
            {% if c_lower not in suggested_lower and c_lower not in removed_cats and c_lower not in ns.seen %}
              {% set is_active = (c == request.query_params.get('category')) %}
              {% set hide_by_default = (loop.index > visible_limit) and (not is_active) %}
              <a role="listitem" data-cat="{{ c }}" class="category-chip{% if is_active %} active{% endif %}{% if hide_by_default %} js-extra-category hidden-category-chip{% endif %}" href="/search?category={{ c|url_encode }}" {% if hide_by_default %}style="display:none;"{% endif %}>{{ c }}</a>
              {% set _ = ns.seen.append(c_lower) %}
            {% endif %}
          {% endfor %}
        </div>
        {% if ns.seen|length > visible_limit %}
          <button id="toggle-all-categories" type="button" class="btn btn--ghost" style="padding:0;border:none;background:transparent;text-decoration:underline;">Show all categories</button>
        {% endif %}
      </div>
    </div>
  </section>
  <script>
    (function () {
      const toggleBtn = document.getElementById('toggle-all-categories');
      if (!toggleBtn) return;
      const extraChips = Array.from(document.querySelectorAll('.js-extra-category'));
      if (!extraChips.length) return;
      let expanded = false;
      toggleBtn.addEventListener('click', function () {
        expanded = !expanded;
        extraChips.forEach(function (chip) {
          chip.style.display = expanded ? '' : 'none';
        });
        toggleBtn.textContent = expanded ? 'Show fewer categories' : 'Show all categories';
      });
    })();
  </script>
  {% endif %}

  <main class="container" style="padding: var(--space-lg) 0;">
    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer">
    <div class="container footer-inline">
      <div class="footer-inline__brand">Â© {{ current_year or 2025 }} FileShare</div>
      <nav class="footer-inline__nav" aria-label="Footer">
        <a href="{{ url_for('help') }}">{{ t_help }}</a>
        <a href="{{ url_for('contact') }}">{{ t_contact }}</a>
        <a href="/terms">{{ t_terms }}</a>
        <a href="/privacy">{{ t_privacy }}</a>
      </nav>
    </div>
  </footer>

  <script src="{{ request.url_for('static', path='js/main.js') }}"></script>
  <script src="{{ request.url_for('static', path='js/chat.js') }}"></script>
  <script src="{{ request.url_for('static', path='js/thumb-fallback.js') }}"></script>
  <script src="{{ request.url_for('static', path='js/cookies.js') }}"></script>
  {% set consent_parsed = request.state.cookie_consent_parsed if request and request.state else None %}
  {# Server-side analytics injection only when user consented to analytics #}
  {% if consent_parsed and consent_parsed.analytics and (env.GA_MEASUREMENT_ID or '') %}
    <!-- Google Analytics (injected after consent) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ env.GA_MEASUREMENT_ID }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
      gtag('config', '{{ env.GA_MEASUREMENT_ID }}');
    </script>
  {% endif %}
  {% if request.state.current_user %}
  <!-- Notification panel -->
  <div id="notif-panel" class="chat-modal" style="display:none;">
    <div class="chat-modal__backdrop"></div>
    <div class="chat-modal__panel" style="width:360px;max-width:calc(100% - 24px);">
      <header class="chat-header">
        <div class="chat-header__title">Notifications</div>
          <a href="{{ url_for('notifications_page') }}" class="btn btn--ghost" style="padding:4px 10px;font-size:13px;">Open page</a>
          <button id="notif-close" class="icon-btn" aria-label="Close notifications">âœ•</button>
      </header>
      <div id="notif-list" style="max-height:420px;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;">
        <!-- notifications loaded via JS -->
      </div>
      <div style="padding:10px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;">
        <button id="notif-mark-all" class="btn btn--ghost">Mark all read</button>
      </div>
    </div>
  </div>

  <!-- Global Chat modal -->
  <div id="chat-modal" class="chat-modal" style="display:none;">
    <div class="chat-modal__backdrop"></div>
    <div class="chat-modal__panel">
      <header class="chat-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <div id="chat-avatar" class="contact-avatar">??</div>
          <div class="chat-header__title" id="chat-username">User</div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <button id="chat-theme-toggle" class="icon-btn" title="Coffee mode">â˜• Coffee</button>
          <button id="chat-clear" class="icon-btn" title="Clear chat">ğŸ—‘</button>
          <button id="chat-audio-call" class="icon-btn" title="Audio call">ğŸ§</button>
          <button id="chat-video-call" class="icon-btn" title="Video call">ğŸ“¹</button>
          <button id="chat-close" class="icon-btn">âœ•</button>
        </div>
      </header>
      <div id="chat-recipient-block" style="padding:10px;border-bottom:1px solid var(--border);">
        <label for="chat-recipient" class="muted">Recipient user id (or select from people you follow):</label>
        <input id="chat-recipient" type="text" placeholder="User id (e.g. 42)" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid var(--border);" />
        <div style="margin-top:8px;">
          <label style="font-size:0.9em;color:var(--muted);"><input id="chat-mutuals-only" type="checkbox" style="margin-right:6px;"/> Mutuals only</label>
          <select id="chat-recipient-select" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid var(--border);display:none"></select>
          <div id="chat-recipient-list" class="chat-recipient-list"></div>
        </div>
      </div>
      <div id="chat-messages" class="chat-messages"></div>
      <div class="chat-status">
        <div id="chat-typing" class="chat-typing" style="display:none;"></div>
        <div id="chat-read-state" class="chat-read"></div>
      </div>
      <form id="chat-form" class="chat-form" enctype="multipart/form-data">
        <input id="chat-input" type="text" placeholder="Write a message..." autocomplete="off" />
        <button class="btn" type="submit">Send</button>
      </form>
    </div>
  </div>

  <!-- Direct call modal -->
  <div id="direct-call-modal" class="chat-modal" style="display:none;">
    <div class="chat-modal__backdrop"></div>
    <div class="chat-modal__panel direct-call-panel">
      <header class="chat-header">
        <div class="chat-header__title">Direct call</div>
        <button id="direct-call-close" class="icon-btn">âœ•</button>
      </header>
      <div class="direct-call-body">
        <div id="direct-call-status" class="muted" style="margin-bottom:10px;">Connecting...</div>
        <div class="direct-call-videos">
          <video id="direct-call-remote" autoplay playsinline></video>
          <video id="direct-call-local" autoplay playsinline muted></video>
        </div>
      </div>
      <div class="direct-call-controls">
        <button id="direct-call-accept" class="btn">Accept</button>
        <button id="direct-call-reject" class="btn btn--ghost">Reject</button>
        <button id="direct-call-end" class="btn btn--ghost">End call</button>
      </div>
    </div>
  </div>

  <!-- Space meeting modal -->
  <div id="space-meeting-modal" class="chat-modal" style="display:none;">
    <div class="chat-modal__backdrop"></div>
    <div class="chat-modal__panel space-meeting-panel">
      <header class="chat-header">
        <div class="chat-header__title" id="space-meeting-title">Space meeting</div>
        <button id="space-meeting-close" class="icon-btn">âœ•</button>
      </header>
      <div class="space-meeting-body">
        <div id="space-video-grid" class="space-video-grid"></div>
        <aside class="space-meeting-sidebar">
          <div class="space-meeting-list-title">Participants</div>
          <ul id="space-participants-list" class="space-participants-list"></ul>
        </aside>
      </div>
      <div class="space-meeting-controls">
        <button id="meeting-toggle-mic" class="btn btn--ghost">Mute</button>
        <button id="meeting-toggle-camera" class="btn btn--ghost">Camera off</button>
        <button id="meeting-share-screen" class="btn btn--ghost">Share screen</button>
        <button id="meeting-leave" class="btn">Leave meeting</button>
      </div>
    </div>
  </div>
  {% endif %}
  <!-- current user marker for client-side scripts -->
  <div id="current-user" data-my-id="{{ request.state.current_user.id if request.state.current_user else '' }}" style="display:none"></div>

  <!-- Sign-in prompt modal (shown to anonymous users when they click Contact Owner) -->
  <div id="signin-modal" class="chat-modal" style="display:none;">
    <div class="chat-modal__backdrop"></div>
    <div class="chat-modal__panel">
      <header class="chat-header">
        <div class="chat-header__title">Sign in to message</div>
        <button id="signin-close" class="icon-btn">âœ•</button>
      </header>
      <div style="padding:16px;">
        <p class="muted">You need to sign in to use direct messaging. You can sign in or contact the owner by email.</p>
        <div style="display:flex;gap:8px;margin-top:12px">
          <a class="btn" id="signin-login" href="{{ url_for('login') }}">Sign in</a>
          <a class="btn btn--ghost" id="signin-register" href="{{ url_for('register') }}">Register</a>
          <a class="btn btn--ghost" id="signin-mailto" href="#">Contact by email</a>
        </div>
      </div>
    </div>
  </div>
  <!-- Contact Owner modal for signed-in users (chat-style composer) -->
  <div id="contact-modal" class="chat-modal" style="display:none;">
    <div class="chat-modal__backdrop"></div>
    <div class="chat-modal__panel contact-panel">
      <header class="chat-header contact-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <div id="contact-owner-avatar" class="contact-avatar">??</div>
          <div>
            <div id="contact-owner-title" class="contact-title">Contact owner</div>
            <div id="contact-owner-subtitle" class="contact-subtitle muted"></div>
          </div>
        </div>
        <button id="contact-close" class="icon-btn">âœ•</button>
      </header>
      <div class="contact-body">
        <div id="contact-thread" class="chat-messages contact-messages">
          <div class="chat-msg other">
            <div class="chat-msg__text" id="contact-intro">You are contacting <span id="contact-owner-label">the owner</span>. Type your message below and weâ€™ll send it to them.</div>
          </div>
        </div>
        <form id="contact-form" class="chat-form contact-form">
          <input type="hidden" id="contact-owner-id" name="owner_id" value="" />
          <input type="hidden" id="contact-owner-username" name="owner_username" value="" />
          <input type="hidden" id="contact-name" name="name" />
          <input type="hidden" id="contact-email" name="email" />
          <textarea id="contact-message" name="message" rows="2" placeholder="Write your messageâ€¦" required></textarea>
          <button type="submit" class="btn">Send</button>
        </form>
        <div id="contact-status" class="muted" style="margin:4px 16px 10px; display:none;"></div>
        <button type="button" id="contact-cancel" class="btn btn--ghost" style="margin:0 16px 14px auto;">Cancel</button>
      </div>
    </div>
  </div>
  <!-- Toast container for UI feedback -->
  <div id="toast-container" aria-live="polite" aria-atomic="true" style="position:fixed;right:16px;bottom:18px;z-index:1200;display:flex;flex-direction:column;gap:8px;pointer-events:none"></div>
  <script src="{{ request.url_for('static', path='js/video_calls.js') }}"></script>
  {% block scripts %}{% endblock %}
</body>
</html>
