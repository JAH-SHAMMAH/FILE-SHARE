{% extends 'base.html' %}
{% block title %}{{ classroom.name }} — Classroom{% endblock %}

{% block content %}
  <section class="container" style="margin-top:18px;max-width:980px;">
    <div id="classroom-meta" data-room-id="{{ classroom.id }}" style="display:none"></div>
    <header style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div>
        <h1 class="section-title" style="margin:0 0 4px 0;">{{ classroom.name }}</h1>
        <p class="muted" style="margin:0;">Group chat space for this classroom, plus materials and tools.</p>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        {% if member and member_role in ['teacher','admin'] %}
        <button id="teacher-menu-toggle" class="btn btn--ghost" style="padding:6px 10px;font-size:14px;display:inline-flex;align-items:center;gap:6px;" onclick="(function(){var p=document.getElementById('teacher-tools-panel');if(!p)return;p.style.display=(p.style.display==='none'?'block':'none');})();">
          <span style="display:inline-block;width:16px;height:2px;background:currentColor;box-shadow:0 5px 0 currentColor,0 -5px 0 currentColor;"></span>
          <span>Teacher tools</span>
        </button>
        {% endif %}
        {% if member and member_role == 'student' %}
        <div class="dropdown" style="position:relative;">
          <button id="student-hamburger" class="btn btn--ghost" style="padding:6px 10px;font-size:14px;display:inline-flex;align-items:center;gap:6px;" onclick="(function(){var m=document.getElementById('student-menu');if(!m)return;m.style.display=(m.style.display==='none' || m.style.display===''?'block':'none');})();">
            <span style="display:inline-block;width:16px;height:2px;background:currentColor;box-shadow:0 5px 0 currentColor,0 -5px 0 currentColor;"></span>
            <span>Menu</span>
          </button>
          <div id="student-menu" style="display:none;position:absolute;right:0;top:110%;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);min-width:160px;z-index:10;">
            <a href="#" id="view-members" style="display:block;padding:10px 16px;text-decoration:none;color:#222;font-size:14px;">View Members</a>
            <a href="#" id="leave-group" style="display:block;padding:10px 16px;text-decoration:none;color:#c00;font-size:14px;">Leave Group</a>
          </div>
        </div>
        {% endif %}
      </div>
    </header>
    <!-- Members Popup Modal -->
    <div id="members-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:24px 28px;border-radius:12px;max-width:400px;width:90vw;box-shadow:0 4px 24px rgba(0,0,0,0.12);position:relative;">
        <button id="close-members-modal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:20px;cursor:pointer;">&times;</button>
        <h3 style="margin-top:0;">Classroom Members</h3>
        <div id="members-list" style="margin-top:12px;min-height:40px;text-align:left;font-size:15px;">
          Loading...
        </div>
      </div>
    </div>

    {% if member and member_role in ['teacher','admin'] %}
    <section class="content-card" id="teacher-tools-panel" style="margin-bottom:14px;padding:10px 12px;display:none;">
      <h2 style="margin:0 0 6px 0;font-size:14px;">Teacher tools</h2>
      <div style="display:flex;flex-wrap:wrap;gap:8px;">
        <a class="btn btn--ghost" href="/classrooms/{{ classroom.id }}/library" style="padding:6px 10px;font-size:13px;">Upload material</a>
        <a class="btn btn--ghost" href="/classrooms/{{ classroom.id }}/assignments" style="padding:6px 10px;font-size:13px;">Assignments</a>
        <a class="btn btn--ghost" href="/classrooms/{{ classroom.id }}/boot" style="padding:6px 10px;font-size:13px;">Boot students</a>
      </div>
    </section>
    {% endif %}

    <div>
      <section class="content-card" style="padding:14px 16px;min-height:480px;display:flex;flex-direction:column;">
        <h2 style="margin:0 0 10px 0;font-size:18px;">{{ classroom.name }}</h2>
        <div id="classroom-chat-messages" style="display:flex;flex-direction:column;gap:8px;flex:1 1 auto;min-height:260px;max-height:420px;overflow-y:auto;margin-top:6px;padding:8px 6px;border-radius:10px;border:1px solid var(--border);background:var(--surface-soft);">
          {% if messages %}
            {% for m in messages %}
              {% set role = (m.site_role|default('passerby'))|lower %}
              <div class="chat-msg {{ 'me' if current_user and current_user.id == m.sender_id else 'other' }}">
                <div class="chat-msg__text">
                  <div style="font-weight:600">{{ m.username or ('User #' ~ m.sender_id) }} <span class="role-badge role-badge--{{ role }}">★</span></div>
                  <div>{{ m.content }}</div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="muted">No messages yet.</div>
          {% endif %}
        </div>

        <form id="class-chat-form" class="chat-form" style="margin-top:8px;display:flex;gap:8px;">
          <input id="class-chat-input" type="text" placeholder="Write a message to the class…" autocomplete="off" style="flex:1;" />
          <button class="btn" type="submit">Send</button>
        </form>

        <!-- Generic modal shell for classroom tools -->
        <div id="classroom-modal-backdrop" style="display:none;position:fixed;inset:0;z-index:90;background:rgba(15,23,42,0.6);">
          <div id="classroom-modal-panel" class="content-card" style="max-width:640px;margin:40px auto;position:relative;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;">
              <h3 id="classroom-modal-title" style="margin:0;font-size:18px;"></h3>
              <button type="button" id="classroom-modal-close" class="hamburger" aria-label="Close">✕</button>
            </div>
            <div id="classroom-modal-body"></div>
          </div>
        </div>

        <script>
        (function(){
          const classroomId = document.getElementById('classroom-meta')?.getAttribute('data-room-id');
          const msgBox = document.getElementById('classroom-chat-messages');
          const form = document.getElementById('class-chat-form');
          const input = document.getElementById('class-chat-input');

          if (!classroomId || !msgBox || !form || !input) return;

          async function loadChat(){
            try{
              const res = await fetch(`/api/classrooms/${classroomId}/chat/messages`);
              if(!res.ok) return;
              const data = await res.json();
              msgBox.innerHTML = '';
              const meIdAttr = document.body.getAttribute('data-my-id') || document.getElementById('current-user')?.getAttribute('data-my-id');
              const meId = meIdAttr ? parseInt(meIdAttr) : null;
              (data.messages || []).forEach(m => {
                const row = document.createElement('div');
                row.className = 'chat-msg ' + (meId && m.sender_id === meId ? 'me' : 'other');
                const inner = document.createElement('div');
                inner.className = 'chat-msg__text';
                const header = document.createElement('div');
                header.style.fontWeight = '600';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = (m.username || ('User #' + m.sender_id));
                header.appendChild(nameSpan);
                const badge = document.createElement('span');
                badge.className = 'role-badge';
                const role = (m.site_role || 'passerby').toString().toLowerCase();
                if (role === 'teacher') badge.className += ' role-badge--teacher';
                else if (role === 'student') badge.className += ' role-badge--student';
                else if (role === 'individual') badge.className += ' role-badge--individual';
                else if (role === 'passerby') badge.className += ' role-badge--passerby';
                badge.textContent = '★';
                badge.title = role.charAt(0).toUpperCase() + role.slice(1);
                header.appendChild(badge);
                const body = document.createElement('div'); body.textContent = m.content; body.style.marginTop = '4px';
                inner.appendChild(header); inner.appendChild(body);
                row.appendChild(inner); msgBox.appendChild(row);
              });
              msgBox.scrollTop = msgBox.scrollHeight;
            }catch(e){ /* ignore */ }
          }

          form.addEventListener('submit', async function(ev){
            ev.preventDefault();
            const val = input.value.trim();
            if(!val) return;
            try{
              const res = await fetch(`/api/classrooms/${classroomId}/chat/messages`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: val })
              });
              if(res.ok){ input.value = ''; await loadChat(); }
            }catch(e){ /* ignore */ }
          });

          loadChat(); setInterval(loadChat, 5000);

          // Members modal handlers
          const viewMembersBtn = document.getElementById('view-members');
          const membersModal = document.getElementById('members-modal');
          const membersList = document.getElementById('members-list');
          const closeMembersBtn = document.getElementById('close-members-modal');
          const leaveBtn = document.getElementById('leave-group');

          if (viewMembersBtn && membersModal && membersList) {
            viewMembersBtn.addEventListener('click', async function(ev){
              ev.preventDefault();
              try {
                membersList.textContent = 'Loading...';
                const res = await fetch(`/api/classrooms/${classroomId}/members`, { credentials: 'include' });
                if (!res.ok) { membersList.textContent = 'Unable to load members'; return; }
                const data = await res.json();
                membersList.innerHTML = '';
                if (!data.members || !data.members.length) { membersList.textContent = 'No members found'; }
                else {
                  const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
                  data.members.forEach(m => {
                    const li = document.createElement('li'); li.style.padding='6px 0';
                    const name = document.createElement('span'); name.textContent = m.username || ('User ' + m.user_id); name.style.fontWeight='600'; name.style.marginRight='8px';
                    const badge = document.createElement('span'); badge.className = 'role-badge role-badge--' + ((m.role||'passerby').toString().toLowerCase()); badge.textContent = '★'; badge.style.marginLeft='6px';
                    li.appendChild(name); li.appendChild(badge);
                    ul.appendChild(li);
                  });
                  membersList.appendChild(ul);
                }
                membersModal.style.display = 'flex';
              } catch (e) { membersList.textContent = 'Error loading members'; }
            });
          }

          if (closeMembersBtn && membersModal) {
            closeMembersBtn.addEventListener('click', function(){ membersModal.style.display = 'none'; });
            membersModal.addEventListener('click', function(ev){ if (ev.target === membersModal) membersModal.style.display = 'none'; });
          }

          if (leaveBtn) {
            leaveBtn.addEventListener('click', async function(ev){
              ev.preventDefault();
              if (!confirm('Leave this classroom? You will lose access to materials.')) return;
              try {
                const res = await fetch(`/classrooms/${classroomId}/leave`, { method: 'POST', credentials: 'include' });
                if (!res.ok) { alert('Unable to leave the classroom'); return; }
                // on success, redirect to your classrooms
                window.location.href = '/my/classrooms';
              } catch (e) { alert('Network error'); }
            });
          }
        })();
        </script>

    </section>
  </div>
</section>
{% endblock %}




